function t(){}function e(t){return t()}function n(){return Object.create(null)}function r(t){t.forEach(e)}function a(t){return"function"==typeof t}function o(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function i(e,...n){if(null==e){for(const t of n)t(void 0);return t}const r=e.subscribe(...n);return r.unsubscribe?()=>r.unsubscribe():r}function s(t){let e;return i(t,(t=>e=t))(),e}function c(t){t.parentNode&&t.parentNode.removeChild(t)}let l;function u(t){l=t}function f(t){(function(){if(!l)throw new Error("Function called outside component initialization");return l})().$$.on_mount.push(t)}const m=[],d=[];let p=[];const h=[],g=Promise.resolve();let v=!1;function b(t){p.push(t)}const A=new Set;let y=0;function M(){if(0!==y)return;const t=l;do{try{for(;y<m.length;){const t=m[y];y++,u(t),L(t.$$)}}catch(t){throw m.length=0,y=0,t}for(u(null),m.length=0,y=0;d.length;)d.pop()();for(let t=0;t<p.length;t+=1){const e=p[t];A.has(e)||(A.add(e),e())}p.length=0}while(m.length);for(;h.length;)h.pop()();v=!1,A.clear(),u(t)}function L(t){if(null!==t.fragment){t.update(),r(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(b)}}const x=new Set;function R(t,e){const n=t.$$;null!==n.fragment&&(!function(t){const e=[],n=[];p.forEach((r=>-1===t.indexOf(r)?e.push(r):n.push(r))),n.forEach((t=>t())),p=e}(n.after_update),r(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function E(t,e){-1===t.$$.dirty[0]&&(m.push(t),v||(v=!0,g.then(M)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function F(o,i,s,f,m,d,p=null,h=[-1]){const g=l;u(o);const v=o.$$={fragment:null,ctx:[],props:d,update:t,not_equal:m,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(i.context||(g?g.$$.context:[])),callbacks:n(),dirty:h,skip_bound:!1,root:i.target||g.$$.root};p&&p(v.root);let A=!1;if(v.ctx=s?s(o,i.props||{},((t,e,...n)=>{const r=n.length?n[0]:e;return v.ctx&&m(v.ctx[t],v.ctx[t]=r)&&(!v.skip_bound&&v.bound[t]&&v.bound[t](r),A&&E(o,t)),e})):[],v.update(),A=!0,r(v.before_update),v.fragment=!!f&&f(v.ctx),i.target){if(i.hydrate){const t=function(t){return Array.from(t.childNodes)}(i.target);v.fragment&&v.fragment.l(t),t.forEach(c)}else v.fragment&&v.fragment.c();i.intro&&((y=o.$$.fragment)&&y.i&&(x.delete(y),y.i(L))),function(t,n,o){const{fragment:i,after_update:s}=t.$$;i&&i.m(n,o),b((()=>{const n=t.$$.on_mount.map(e).filter(a);t.$$.on_destroy?t.$$.on_destroy.push(...n):r(n),t.$$.on_mount=[]})),s.forEach(b)}(o,i.target,i.anchor),M()}var y,L;u(g)}class w{$$=void 0;$$set=void 0;$destroy(){R(this,1),this.$destroy=t}$on(e,n){if(!a(n))return t;const r=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return r.push(n),()=>{const t=r.indexOf(n);-1!==t&&r.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}"undefined"!=typeof window&&(window.__svelte||(window.__svelte={v:new Set})).v.add("4");var _=1e-6,P="undefined"!=typeof Float32Array?Float32Array:Array;function S(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var T=function(t,e,n,r,a){var o,i=1/Math.tan(e/2);return t[0]=i/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=a&&a!==1/0?(o=1/(r-a),t[10]=(a+r)*o,t[14]=2*a*r*o):(t[10]=-1,t[14]=-2*r),t};const B=[];function $(e,n=t){let r;const a=new Set;function i(t){if(o(e,t)&&(e=t,r)){const t=!B.length;for(const t of a)t[1](),B.push(t,e);if(t){for(let t=0;t<B.length;t+=2)B[t][0](B[t+1]);B.length=0}}}function s(t){i(t(e))}return{set:i,update:s,subscribe:function(o,c=t){const l=[o,c];return a.add(l),1===a.size&&(r=n(i,s)||t),o(e),()=>{a.delete(l),0===a.size&&r&&(r(),r=null)}}}}function C(e,n,o){const s=!Array.isArray(e),c=s?[e]:e;if(!c.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const l=n.length<2;return u=(e,o)=>{let u=!1;const f=[];let m=0,d=t;const p=()=>{if(m)return;d();const r=n(s?f[0]:f,e,o);l?e(r):d=a(r)?r:t},h=c.map(((t,e)=>i(t,(t=>{f[e]=t,m&=~(1<<e),u&&p()}),(()=>{m|=1<<e}))));return u=!0,p(),function(){r(h),d(),u=!1}},{subscribe:$(o,u).subscribe};var u}const D=(t,e)=>{const n=Function.constructor(...Object.entries(e).map((([t,e])=>(""===e&&(e='""'),`${t}${null!=e?`=${e}`:""}`))),`return \`${t}\``);return t=>n(...Object.keys(e).map((e=>null!=t[e]?t[e]:void 0)))};function O(t){return Array.isArray(t)?[...t]:"number"==typeof t?I(t):"string"==typeof t&&t.startsWith("#")?I(parseInt(t.replace("#","0x"))):t}function I(t){return[(t>>16&255)/255,(t>>8&255)/255,(255&t)/255]}function U(t,e){return 3===e?t:t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}const N=0,V=Math.PI/180;function Y(t){return function(){const e=(t=s(t)).gl.createProgram();t.program=e}}function k(t){return function(){const e=(t=s(t)).gl,n=t.program;e.linkProgram(n),e.getProgramParameter(n,e.LINK_STATUS)||console.error("ERROR linking program!",e.getProgramInfoLog(n)),e.validateProgram(n),e.getProgramParameter(n,e.VALIDATE_STATUS)||console.error("ERROR validating program!",e.getProgramInfoLog(n)),e.useProgram(n)}}function j(t,{diffuse:e,metalness:n}){return function(){const r=(t=s(t)).gl,a=t.program,o=r.getUniformLocation(a,"diffuse");r.uniform3fv(o,new Float32Array(e.map(U)));const i=r.getUniformLocation(a,"metalness");r.uniform1f(i,n)}}function W(t,e){return function(){const n=(t=s(t)).gl,r=t.program,a=n.getUniformLocation(r,"projection"),o=e.fov*V;const i=t.canvas.width/t.canvas.height,c=e.near,l=e.far;let u=new Float32Array(16);u=T(u,o,i,c,l),n.uniformMatrix4fv(a,!1,u);const f=n.getUniformLocation(r,"view"),m=new Float32Array(16);var d,p,h,g,v,b,A,y,M,L,x,R,E,F,w,P,B,$,C,D,O,I,U;d=m,p=e.position,h=e.target,g=e.up,w=p[0],P=p[1],B=p[2],$=g[0],C=g[1],D=g[2],O=h[0],I=h[1],U=h[2],Math.abs(w-O)<_&&Math.abs(P-I)<_&&Math.abs(B-U)<_?S(d):(x=w-O,R=P-I,E=B-U,v=C*(E*=F=1/Math.hypot(x,R,E))-D*(R*=F),b=D*(x*=F)-$*E,A=$*R-C*x,(F=Math.hypot(v,b,A))?(v*=F=1/F,b*=F,A*=F):(v=0,b=0,A=0),y=R*A-E*b,M=E*v-x*A,L=x*b-R*v,(F=Math.hypot(y,M,L))?(y*=F=1/F,M*=F,L*=F):(y=0,M=0,L=0),d[0]=v,d[1]=y,d[2]=x,d[3]=0,d[4]=b,d[5]=M,d[6]=R,d[7]=0,d[8]=A,d[9]=L,d[10]=E,d[11]=0,d[12]=-(v*w+b*P+A*B),d[13]=-(y*w+M*P+L*B),d[14]=-(x*w+R*P+E*B),d[15]=1),n.uniformMatrix4fv(f,!1,m);const N=n.getUniformLocation(r,"cameraPosition");n.uniform3fv(N,e.position)}}function G(t,e,n){return null==n?function(){const n=(t=s(t)).gl,r=t.program;e||S(e=new Float32Array(16)),t.transformMatrix=e;const a=n.getUniformLocation(r,"world");n.uniformMatrix4fv(a,!1,e)}:function(){t=s(t);const{gl:r,program:a,vao:o}=t,i=t.transformMatricesWindows=t.transformMatricesWindows||[],c=e.reduce(((t,e)=>[...t,...s(e)]),[]),l=new Float32Array(c);for(let t=0;t<n;++t){const e=16*t*4,n=16;i.push(new Float32Array(l.buffer,e,n))}r.bindVertexArray(o);const u=r.createBuffer();t.matrixBuffer=u;const f=r.getAttribLocation(a,"world");r.bindBuffer(r.ARRAY_BUFFER,u),r.bufferData(r.ARRAY_BUFFER,l.byteLength,r.DYNAMIC_DRAW);for(let t=0;t<4;++t){const e=f+t;r.enableVertexAttribArray(e);const n=16*t;r.vertexAttribPointer(e,4,r.FLOAT,!1,64,n),r.vertexAttribDivisor(e,1)}r.bufferSubData(r.ARRAY_BUFFER,0,l),r.bindVertexArray(null)}}function z(t,e){return null==e?function(){const{gl:e,program:n,transformMatrix:r}=s(t),a=e.getUniformLocation(n,"normalMatrix");t.normalMatrixLocation=a,e.uniformMatrix4fv(a,!1,H(r))}:function(){t=s(t);const{gl:n,program:r,transformMatrix:a,vao:o,transformMatricesWindows:i}=t;n.bindVertexArray(o);const c=n.getAttribLocation(r,"normalMatrix"),l=[];for(let t=0;t<e;t++)l.push(...H(i[t]));const u=new Float32Array(l),f=n.createBuffer();t.normalMatrixBuffer=f,n.bindBuffer(n.ARRAY_BUFFER,f),n.bufferData(n.ARRAY_BUFFER,u.byteLength,n.DYNAMIC_DRAW),n.bufferSubData(n.ARRAY_BUFFER,0,u);for(let t=0;t<4;++t){const e=c+t;n.enableVertexAttribArray(e);const r=16*t;n.vertexAttribPointer(e,4,n.FLOAT,!1,64,r),n.vertexAttribDivisor(e,1)}n.bindVertexArray(null)}}function H(t){const e=(n=new P(16),P!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n);var n;return function(t,e){var n=e[0],r=e[1],a=e[2],o=e[3],i=e[4],s=e[5],c=e[6],l=e[7],u=e[8],f=e[9],m=e[10],d=e[11],p=e[12],h=e[13],g=e[14],v=e[15],b=n*s-r*i,A=n*c-a*i,y=n*l-o*i,M=r*c-a*s,L=r*l-o*s,x=a*l-o*c,R=u*h-f*p,E=u*g-m*p,F=u*v-d*p,w=f*g-m*h,_=f*v-d*h,P=m*v-d*g,S=b*P-A*_+y*w+M*F-L*E+x*R;S&&(S=1/S,t[0]=(s*P-c*_+l*w)*S,t[1]=(a*_-r*P-o*w)*S,t[2]=(h*x-g*L+v*M)*S,t[3]=(m*L-f*x-d*M)*S,t[4]=(c*F-i*P-l*E)*S,t[5]=(n*P-a*F+o*E)*S,t[6]=(g*y-p*x-v*A)*S,t[7]=(u*x-m*y+d*A)*S,t[8]=(i*_-s*F+l*R)*S,t[9]=(r*F-n*_-o*R)*S,t[10]=(p*L-h*y+v*b)*S,t[11]=(f*y-u*L-d*b)*S,t[12]=(s*E-i*w-c*R)*S,t[13]=(n*w-r*E+a*R)*S,t[14]=(h*A-p*M-g*b)*S,t[15]=(u*M-f*A+m*b)*S)}(e,t),function(t,e){if(t===e){var n=e[1],r=e[2],a=e[3],o=e[6],i=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=o,t[11]=e[14],t[12]=a,t[13]=i,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]}(e,e),e}function q(t){let e,n;t.data?(e=t.data,n=t.interleaved):e=t;return{data:e.buffer&&e.buffer instanceof ArrayBuffer?e:new Float32Array(e),interleaved:n,...n?{byteStride:t.byteStride,byteOffset:t.byteOffset}:{}}}function X(t,e){return function(){const n=(t=s(t)).gl,r=t.program;t.attributeLength=e.attributes.elements?e.attributes.elements.length:e.attributes.positions.length/3;const{positions:a,normals:o,elements:i,uvs:c}=e.attributes,l=t.vao=n.createVertexArray();n.bindVertexArray(l);const{data:u,interleaved:f,byteStride:m,byteOffset:d}=q(a),p=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,p),n.bufferData(n.ARRAY_BUFFER,u,n.STATIC_DRAW);const h=n.getAttribLocation(r,"position");n.bindBuffer(n.ARRAY_BUFFER,p),n.vertexAttribPointer(h,3,n.FLOAT,!1,m,d),n.enableVertexAttribArray(h);const{data:g,interleaved:v,byteStride:b,byteOffset:A}=q(o);if(!v){const t=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,t),n.bufferData(n.ARRAY_BUFFER,g,n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,t)}const y=n.getAttribLocation(r,"normal");if(n.vertexAttribPointer(y,3,n.FLOAT,!1,b,A),n.enableVertexAttribArray(y),e.attributes.elements){t.hasElements=!0;const r=new Uint16Array(e.attributes.elements),a=n.createBuffer();n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,a),n.bufferData(n.ELEMENT_ARRAY_BUFFER,r,n.STATIC_DRAW)}if(e.attributes.uvs){const t=new Float32Array(e.attributes.uvs),a=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,a),n.bufferData(n.ARRAY_BUFFER,t,n.STATIC_DRAW);const o=n.getAttribLocation(r,"uv");n.bindBuffer(n.ARRAY_BUFFER,a),n.vertexAttribPointer(o,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(o)}n.bindVertexArray(null)}}const K=(t,e,n)=>{const r=$(e),{subscribe:a,set:o,update:i}=r,c={subscribe:a,set:e=>{i((t=>(nt&&s(nt).program&&t.updateOneLight(nt,s(J).lights,c),{...t,...e}))),t((t=>(t.lights[n]=c,t)))}};return c},J=function(){const{subscribe:t,set:e,update:n}=$({backgroundColor:[2.55,2.55,2.55,1],canvas:null,camera:null,meshes:[],lights:[],toneMappings:[],loop:null,enabled:!1,ambientLightColor:[0,0,0]});return{subscribe:t,setCamera:(...t)=>{return e(...t),{set:(...t)=>{e(...t),W(nt,s(J).camera)()},get:()=>s(J).camera};function e(t=[0,0,-1],e=[0,0,0],r=80,a=.1,o=1e3,i=[0,1,0],s=null){n((n=>(n.camera={fov:r,near:a,far:o,position:t,target:e,up:i,matrix:s},n)))}},addMesh:t=>{const e=s(J).meshes.length;if(t.instances&&t.instances>1)var{matrices:r,unsubs:a}=new Array(t.instances).fill().reduce(((r,a,o)=>{const{transformMatrix:i,unsubNormalMatrix:s}=Z(n,e,o,t.matrices[o]);return r.matrices.push(i),r.unsubs.push(s),r}),{matrices:[],unsubs:[]});else var{transformMatrix:o,unsubNormalMatrix:i}=Z(n,e,null,t.transformMatrix);t.material={metalness:0,...t.material};const c={...t,...r?{matrices:r,unsubs:a}:{transformMatrix:o},unsub:()=>{r?a.forEach((t=>t())):i()},animations:[]};return n((t=>(t.meshes=[...t.meshes,c],t))),c},removeMesh:t=>{n((e=>(e.meshes=e.meshes.filter((e=>e!==t)),e))),t.unsub()},setAmbientLight:(t,e)=>{n((n=>(n.ambientLightColor=O(t).map((t=>t*e)),n)))},addLight:t=>{const e=s(J).lights.length,r=K(n,t,e);return n((t=>(t.lights=[...t.lights,r],t))),{remove:()=>n((e=>(e.lights=e.lights.filter((e=>e!==t)),e))),set:r.set}},addToneMapping:t=>n((e=>(e.toneMappings=[...e.toneMappings,t],e))),addAnimation:(t,e)=>n((n=>(n.meshes=n.meshes.map((n=>(n===t&&n.animations.push(e),n))),n))),setLoop:t=>n((e=>(e.loop=t,e))),setCanvas:t=>n((e=>(e.canvas=t,e))),setBackgroundColor:t=>{t=[...O(t),1],n((e=>(e.backgroundColor=t,e)))},start:()=>n((t=>(t.enabled=!0,t))),stop:()=>n((t=>(t.enabled=!1,t)))}}(),Q=new Float32Array(16);S(Q);const Z=(t,e,n,r)=>{const{subscribe:a,set:o}=$(r||Q),i={subscribe:a,set:r=>(o(r),nt&&s(nt).program&&(1===s(tt).length?(null==n?function(t,e){const n=(t=s(t)).gl,r=t.program,a=n.getUniformLocation(r,"world");n.uniformMatrix4fv(a,!1,e)}(nt,r):function(t,e,n){t=s(t);const{gl:r,program:a,vao:o,matrixBuffer:i}=t;r.bindVertexArray(o),r.bindBuffer(r.ARRAY_BUFFER,i),r.bufferSubData(r.ARRAY_BUFFER,64*n,e),r.bindVertexArray(null)}(nt,r,n),t((t=>(t.meshes[e].transformMatrix=r,t)))):et.set({init:!1})),r)},c=C(i,(t=>{const e=s(nt);if(!e.gl)return;const r=H(t);return null==n?function({gl:t,program:e},n){const r=t.getUniformLocation(e,"normalMatrix");t.uniformMatrix4fv(r,!1,n)}(e,r):function({gl:t,program:e,vao:n,normalMatrixBuffer:r},a,o){t.bindVertexArray(n),t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferSubData(t.ARRAY_BUFFER,64*o,a),t.bindVertexArray(null)}(e,r,n),r}));return{transformMatrix:i,unsubNormalMatrix:c.subscribe((()=>{}))}},tt=C(J,(t=>t.meshes.map((t=>({createProgram:Y,mesh:t,attributes:t.attributes,uniforms:t.uniforms,createShaders:function(t,e){return function(){const n=(t=s(t)).gl,r=t.program;let a="",o="",i="",c="";const l=e.animations?.filter((({type:t})=>"vertex"===t));l.length>0&&(i+=l.reduce(((t,e)=>t+e.shader({declaration:!0})),""),c+=l.reduce(((t,e)=>t+e.shader({position:!0})),""),a+=i,o+=c);const u=D("#version 300 es\r\nprecision mediump float;\r\n    \r\nin vec3 position;\r\nin vec3 normal;\r\nin vec2 uv;\r\n${instances ?\r\n`\r\nin mat4 world;\r\nin mat4 normalMatrix;\r\n` : `\r\nuniform mat4 world;\r\nuniform mat4 normalMatrix;\r\n`}\r\n\r\n\r\nuniform float time;\r\nuniform mat4 view;\r\nuniform mat4 projection;\r\n\r\n// Pass the color attribute down to the fragment shader\r\nout vec3 vertexColor;\r\nout vec3 vNormal;\r\nout vec3 vertex;\r\nout vec3 vViewPosition;\r\nout highp vec2 vUv;\r\n\r\n${declarations}\r\n\r\nvoid main() {\r\n    vec3 modifiedNormal = normal;\r\n    vec3 animatedPosition = position;\r\n    ${positionModifier}\r\n\r\n    vUv = vec3( uv, 1 ).xy;\r\n    // Pass the color down to the fragment shader\r\n    vertexColor = vec3(1.27,1.27,1.27);\r\n    // Pass the vertex down to the fragment shader\r\n    //vertex = vec3(world * vec4(position, 1.0));\r\n    vertex = vec3(world * vec4(animatedPosition, 1.0));\r\n    // Pass the normal down to the fragment shader\r\n    // todo : use modifiedNormal when effect is done\r\n    vNormal = vec3(normalMatrix * vec4(modifiedNormal , 1.0));\r\n    //vNormal = normal;\r\n    \r\n    // Pass the position down to the fragment shader\r\n    gl_Position = projection * view * world * vec4(animatedPosition, 1.0);\r\n    vViewPosition = -gl_Position.xyz;\r\n}",{instances:!1,declarations:"",positionModifier:""})({instances:e.instances>1,declarations:a,positionModifier:o}),f=n.createShader(n.VERTEX_SHADER);n.shaderSource(f,u),n.compileShader(f),n.getShaderParameter(f,n.COMPILE_STATUS)||console.error("ERROR compiling vertex shader!",n.getShaderInfoLog(f));let m="",d="";e.material?.specular&&(d=e.material.specular.shader({declaration:!0}),m=e.material.specular.shader({irradiance:!0}));let p="",h="";e.material?.diffuseMap&&(p=e.material.diffuseMap.shader({declaration:!0,mapType:e.material.diffuseMap.type}),h=e.material.diffuseMap.shader({diffuseMapSample:!0,mapType:e.material.diffuseMap.type,coordinateSpace:e.material.diffuseMap.coordinateSpace}));let g="",v="";e.material?.normalMap&&(g=e.material.normalMap.shader({declaration:!0,mapType:e.material.normalMap.type}),v=e.material.normalMap.shader({normalMapSample:!0,mapType:e.material.normalMap.type}));const b=D("#version 300 es\r\nprecision mediump float;\r\n\r\n${defines}\r\n\r\n#define RECIPROCAL_PI 0.3183098861837907\r\n\r\nuniform vec3 diffuse;\r\nuniform float metalness;\r\nuniform vec3 ambientLightColor;\r\nuniform vec3 cameraPosition;\r\n//uniform mat3 normalMatrix;\r\n\r\nin vec3 vertex;\r\nin vec3 vNormal;\r\nin highp vec2 vUv;\r\nin vec3 vViewPosition;\r\n\r\nout vec4 fragColor;\r\n\r\nstruct ReflectedLight {\r\n\tvec3 directDiffuse;\r\n\tvec3 directSpecular;\r\n\tvec3 indirectDiffuse;\r\n\tvec3 indirectSpecular;\r\n};\r\n\r\nstruct PhysicalMaterial {\r\n\tvec3 diffuseColor;\r\n\tfloat roughness;\r\n\tvec3 specularColor;\r\n\tfloat specularF90;\r\n\tfloat ior;\r\n};\r\n\r\nvec3 BRDF_Lambert(const in vec3 diffuseColor) {\r\n\treturn RECIPROCAL_PI * diffuseColor;\r\n}\r\n\r\n\r\n${declarations}\r\n\r\nvec4 sRGBTransferOETF(in vec4 value) {\r\n\treturn vec4(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))), value.a);\r\n}\r\n\r\nvec4 linearToOutputTexel(vec4 value) {\r\n\treturn (sRGBTransferOETF(value));\r\n}\r\n\r\nvoid main() {\r\n    PhysicalMaterial material;\r\n\tmaterial.diffuseColor = diffuse.rgb * (1.0 - metalness);\r\n\t${diffuseMapSample}\r\n\t\r\n\r\n\tvec3 normal = normalize( vNormal );\r\n\t${normalMapSample}\r\n\r\n    ReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\r\n\r\n    reflectedLight.indirectDiffuse += ambientLightColor * BRDF_Lambert(material.diffuseColor);\r\n\r\n    vec3 totalIrradiance = vec3(0.0f);\r\n    ${irradiance}\r\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse + reflectedLight.directDiffuse + reflectedLight.directSpecular;\r\n    fragColor = vec4(outgoingLight, 1.0f);\r\n    //fragColor = vec4(totalIrradiance, 1.0f);\r\n    ${toneMapping}\r\n\tfragColor = linearToOutputTexel(fragColor);\r\n}",{defines:"",declarations:"",diffuseMapSample:"",normalMapSample:"",irradiance:"",toneMapping:"",numPointLights:0})({defines:(A={...t.numPointLights?{NUM_POINT_LIGHTS:t.numPointLights}:void 0},["",...Object.entries(A).map((([t,e])=>`#define ${t} ${e}`))].join("\n")),declarations:[...t.numPointLights?[t.pointLightShader({declaration:!0,irradiance:!1})]:[],...t.toneMappings?.length>0?[...t.toneMappings.map((t=>t.shader({declaration:!0,exposure:t.exposure})))]:[],...e.material?.specular?[d]:[],...e.material?.diffuseMap?[p]:[],...e.material?.normalMap?[g]:[]].join("\n"),diffuseMapSample:h,normalMapSample:v,irradiance:[...t.numPointLights?[t.pointLightShader({declaration:!1,irradiance:!0,specularIrradiance:m})]:[]].join("\n"),toneMapping:[...t.toneMappings?.length>0?[...t.toneMappings.map((t=>t.shader({color:!0})))]:[]].join("\n"),numPointLights:t.numPointLights});var A;const y=n.createShader(n.FRAGMENT_SHADER);n.shaderSource(y,b),n.compileShader(y),n.getShaderParameter(y,n.COMPILE_STATUS)||console.error("ERROR compiling fragment shader!",n.getShaderInfoLog(y)),n.attachShader(r,f),n.attachShader(r,y)}},endProgramSetup:k}))))),et=$({init:!1}),nt=$({}),rt=$(null),at=[],ot=C([J,tt],(([t,e])=>{if(!t.enabled||4===s(it))return at;const n=t.lights.filter((t=>"point"===s(t).type)).length,r=s(t.lights.find((t=>"point"===s(t).type))).shader,a=e.some((t=>t.mesh.animations?.some((t=>t.requireTime))));let o={canvas:t.canvas,backgroundColor:t.backgroundColor,...t.toneMappings.length>0?{toneMappings:t.toneMappings}:void 0,...n>0?{numPointLights:n,pointLightShader:r}:void 0};const i=[];var c;return nt.update((t=>({...t,...o}))),!s(et).init&&i.push(function(t,e){return function(){const n=t.canvas.getBoundingClientRect();t.canvas.width=n.width,t.canvas.height=n.height;const r=t.gl=t.canvas.getContext("webgl2");e.update((e=>({...e,...t}))),r.viewportWidth=t.canvas.width,r.viewportHeight=t.canvas.height,r.clearColor.apply(r,t.backgroundColor),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_COLOR_BIT),r.enable(r.DEPTH_TEST),r.enable(r.CULL_FACE),r.frontFace(r.CCW),r.cullFace(r.BACK),et.set({init:!0})}}(o,nt)),!s(et).init&&i.push(...e.reduce(((e,n)=>{rt.set(n);const r=n.mesh.animations?.map((t=>t.setupAnimation(nt)))||[];return[...e,n.createProgram(nt),n.createShaders(nt,n.mesh),n.endProgramSetup(nt),(a=nt,o=t.ambientLightColor,function(){a=s(a);const{gl:t,program:e}=a,n=t.getUniformLocation(e,"ambientLightColor");t.uniform3fv(n,new Float32Array(o))}),...n.mesh.material?[j(nt,n.mesh.material)]:[],...n.mesh.material?.diffuseMap?[n.mesh.material?.diffuseMap.setupTexture(nt)]:[],...n.mesh.material?.normalMap?[n.mesh.material?.normalMap.setupTexture(nt)]:[],X(nt,n.mesh),W(nt,t.camera),...n.mesh?.material?.specular?[n.mesh.material.specular.setupSpecular(nt)]:[],G(nt,null==n.mesh.instances?s(n.mesh.transformMatrix):n.mesh.matrices,n.mesh.instances),...r,z(nt,n.mesh.instances),...[...t.lights.reduce(((t,e)=>{const n=s(e);return t.set(n.type,n.setupLights),t}),new Map)].map((([e,n])=>n(nt,t.lights)))];var a,o}),[])),i.push(...a?[(c=nt,function(){const t=s(c),e=t.gl,n=t.program,r=e.getUniformLocation(n,"time");e.uniform1f(r,performance.now())})]:[],function(t,e,n){return function(){const r=s(t),a=r.gl;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),r.loop&&r.loop(),a.bindVertexArray(r.vao),e?a.drawArraysInstanced(a[n],0,r.attributeLength,e):r.hasElements?a.drawElements(a[n],r.attributeLength,a.UNSIGNED_SHORT,0):a.drawArrays(a[n],0,r.attributeLength),a.bindVertexArray(null)}}(nt,e[0].mesh.instances,e[0].mesh.drawMode)),i}),at),it=$(0);var st;C([ot],(([t])=>{if(0===t.length)return 0;if(!s(et).init&&0===s(it))return it.set(1),t.forEach((t=>t())),it.set(2),1;if(2===s(it))return it.set(3),requestAnimationFrame((async function e(){4!==s(it)&&(it.set(4),s(J).loop&&s(J).loop(),t.forEach((t=>t())),it.set(3));requestAnimationFrame(e)})),2})).subscribe((t=>{console.log("render loop store subscribed",t)})),st=new P(3),P!=Float32Array&&(st[0]=0,st[1]=0,st[2]=0);let ct=null;const lt=t=>{ct=t},ut=()=>ct;function ft(t,e,n){var r,a;e.preMultipliedColor=[...e.color],r=e.preMultipliedColor,a=e.intensity,r[0]*=a,r[1]*=a,r[2]*=a,t[n]=e.position[0],t[n+1]=e.position[1],t[n+2]=e.position[2],t[n+4]=e.preMultipliedColor[0],t[n+5]=e.preMultipliedColor[1],t[n+6]=e.preMultipliedColor[2],t[n+7]=e.cutoffDistance,t[n+8]=e.decayExponent,t[n+9]=0,t[n+10]=0,t[n+11]=0,t[n+12]=0}function mt(t,e){return function(){const n=(t=s(t)).gl,r=t.program;ut()||function({gl:t},e){const n=e.filter((t=>"point"===s(t).type)),r=n.length,a=new Float32Array(12*r);for(let t=0;t<r;t++)ft(a,s(n[t]),12*t);const o=t.createBuffer();lt(o),t.bindBufferBase(t.UNIFORM_BUFFER,N,o),t.bufferData(t.UNIFORM_BUFFER,a,t.DYNAMIC_DRAW)}(t,e);const a=n.getUniformBlockIndex(r,"PointLights");n.uniformBlockBinding(r,a,N)}}function dt(t,e,n){const r=(t=s(t)).gl,a=e.filter((t=>"point"===s(t).type)).findIndex((t=>t===n)),o=ut();if(-1!==a){const t=new Float32Array(12),e=12*a;ft(t,s(n),e),r.bindBuffer(r.UNIFORM_BUFFER,o),r.bufferSubData(r.UNIFORM_BUFFER,e*Float32Array.BYTES_PER_ELEMENT,t)}}const pt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ht={MAT2:4,MAT3:9,MAT4:16,SCALAR:1,VEC2:2,VEC3:3,VEC4:4},gt={0:"POINTS",1:"LINES",2:"LINE_LOOP",3:"LINE_STRIP",4:"TRIANGLES",5:"TRIANGLE_STRIP",6:"TRIANGLE_FAN"};async function vt(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch GLB file: ${e.statusText}`);const n=await e.json();return await async function(t,e){const n=e.substring(0,e.lastIndexOf("/")+1),{buffers:r,bufferViews:a,accessors:o,scenes:i,nodes:s,meshes:c,cameras:l,materials:u,scene:f}=t,m=await Promise.all(r.map((async t=>{const{uri:e}=t,r=await fetch(n+e);if(!r.ok)throw new Error(`Failed to fetch buffer: ${r.statusText}`);return await r.arrayBuffer()}))),d=await Promise.all(a.map((async t=>{const{buffer:e,byteOffset:n,byteLength:r,byteStride:a}=t;return{dataView:m[e].slice(n,n+r),byteStride:a}}))),p={};function h(t,e){return p[t]&&p[t][e]}function g(t,e,n){p[e]=p[e]||{},p[e][n]=t}function v(t,e){return p[t]&&null!=p[t][e]}const b=o.map((t=>{const{bufferView:e,byteOffset:n}=t,{dataView:r,byteStride:a}=d[e],{type:o,componentType:i,count:s,min:c,max:l}=t,u=ht[o],f=pt[i],m=f.BYTES_PER_ELEMENT;let p,b,A,y=!1;if(null!=a&&a!==m*u){p=Math.floor(n/a)*a,b=s*a/m,y=!0}else p=n,b=s*u;return y&&v(r,p)?A=h(r,p):(A=new f(r,p,b),y&&g(A,r,p)),{type:o,componentType:i,count:s,min:c,max:l,data:A,interleaved:y,...y?{byteOffset:n,byteStride:a}:{}}})),A=c.map((t=>R(t)));let y=s.map((t=>null!=t.mesh?{...A[t.mesh],matrix:At(t)}:null!=t.camera?E(t):null!=t.children?t:void 0));y=y.map((t=>null!=t.children?w(t):t));const M=i[f];let{nodes:L}=M,x=L.map((t=>y[t]));x.forEach((t=>{F(t)}));return{scene:x,materials:u,lights:{},cameras:l};function R(t){const{primitives:e}=t;return e.map((t=>{const{attributes:e,indices:n}=t,{POSITION:r,NORMAL:a,TEXCOORD_0:o}=e,i=b[r],s=b[a],c=b[o];return{position:i,normal:s,indices:b[n],uv:c,material:t.material,drawMode:gt[t.mode]}}))[0]}function E(t){return null!=t.matrix||null==t.scale&&null==t.translation&&null==t.rotation?null==t.matrix&&(t.matrix=S(new Float32Array(16))):t.matrix=At(t),{...t,...l[t.camera]}}function F(t,e=null){const{children:n}=t;if(null!=e&&(t.parent=e),null!=n)return n.map((e=>{F(e,t)}))}function w(t){const{children:e,matrix:n,scale:r,translation:a,rotation:o}=t;let i;return i=null!=n||null==r&&null==a&&null==o?null!=n?n:S(new Float32Array(16)):At(t),{children:e.map((t=>null!=y[t].children?w(y[t]):y[t])),matrix:i}}}(n,t)}catch(t){console.error("Error loading GLTF file:",t)}}function bt(t){const e=[];let n=t;for(;null!=n.parent;)e.unshift(n.matrix),n=n.parent;return e.reduce(((t,e)=>function(t,e,n){var r=e[0],a=e[1],o=e[2],i=e[3],s=e[4],c=e[5],l=e[6],u=e[7],f=e[8],m=e[9],d=e[10],p=e[11],h=e[12],g=e[13],v=e[14],b=e[15],A=n[0],y=n[1],M=n[2],L=n[3];return t[0]=A*r+y*s+M*f+L*h,t[1]=A*a+y*c+M*m+L*g,t[2]=A*o+y*l+M*d+L*v,t[3]=A*i+y*u+M*p+L*b,A=n[4],y=n[5],M=n[6],L=n[7],t[4]=A*r+y*s+M*f+L*h,t[5]=A*a+y*c+M*m+L*g,t[6]=A*o+y*l+M*d+L*v,t[7]=A*i+y*u+M*p+L*b,A=n[8],y=n[9],M=n[10],L=n[11],t[8]=A*r+y*s+M*f+L*h,t[9]=A*a+y*c+M*m+L*g,t[10]=A*o+y*l+M*d+L*v,t[11]=A*i+y*u+M*p+L*b,A=n[12],y=n[13],M=n[14],L=n[15],t[12]=A*r+y*s+M*f+L*h,t[13]=A*a+y*c+M*m+L*g,t[14]=A*o+y*l+M*d+L*v,t[15]=A*i+y*u+M*p+L*b,t}(t,t,e)),S(new Float32Array(16)))}function At(t){const{translation:e,rotation:n,scale:r}=t,a=S(new Float32Array(16));return function(t,e,n,r){var a=e[0],o=e[1],i=e[2],s=e[3],c=a+a,l=o+o,u=i+i,f=a*c,m=a*l,d=a*u,p=o*l,h=o*u,g=i*u,v=s*c,b=s*l,A=s*u,y=r[0],M=r[1],L=r[2];t[0]=(1-(p+g))*y,t[1]=(m+A)*y,t[2]=(d-b)*y,t[3]=0,t[4]=(m-A)*M,t[5]=(1-(f+g))*M,t[6]=(h+v)*M,t[7]=0,t[8]=(d+b)*L,t[9]=(h-v)*L,t[10]=(1-(f+p))*L,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1}(a,n||[0,0,0,0],e||[0,0,0],r||[1,1,1]),a}function yt(t,e){t.forEach((t=>{e(t),null!=t.children&&yt(t.children,e)}))}function Mt(e){let n;return{c(){var t;t="canvas",n=document.createElement(t)},m(t,r){!function(t,e,n){t.insertBefore(e,n||null)}(t,n,r),e[1](n)},p:t,i:t,o:t,d(t){t&&c(n),e[1](null)}}}function Lt(){}function xt(t,e,n){let r;return f((async()=>{const t=await vt("models/v2/md-blend6-mdlvw.gltf");let e,n;yt(t.scene,(t=>{null!=t.position?e=t:null!=t.camera&&(n=t)}));const a=bt(n),o=function(t){const{perspective:e,translation:n}=t;return{position:n,target:[0,0,0],fov:e.yfov/Math.PI*180,near:e.znear,far:e.zfar,up:[0,1,0]}}(n);!function(t,e,n){var r=e[0],a=e[1],o=e[2],i=n[3]*r+n[7]*a+n[11]*o+n[15];i=i||1,t[0]=(n[0]*r+n[4]*a+n[8]*o+n[12])/i,t[1]=(n[1]*r+n[5]*a+n[9]*o+n[13])/i,t[2]=(n[2]*r+n[6]*a+n[10]*o+n[14])/i}(o.position,o.position,a);const i=bt(e);!function(t,e,n){var r=n[0],a=n[1],o=n[2];t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*a,t[5]=e[5]*a,t[6]=e[6]*a,t[7]=e[7]*a,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(i,i,[3,3,3]),e.matrix=i;const s=function(t,e){const n=e,r=t.materials[n.material],a={};if(r.pbrMetallicRoughness){const{baseColorFactor:t,metallicFactor:e,roughnessFactor:n}=r.pbrMetallicRoughness;a.diffuse=t.slice(0,3)}return{attributes:{positions:n.position.interleaved?{data:n.position.data,interleaved:n.position.interleaved,byteOffset:n.position.byteOffset,byteStride:n.position.byteStride}:n.position.data,normals:n.normal.interleaved?{data:n.normal.data,interleaved:n.normal.interleaved,byteOffset:n.normal.byteOffset,byteStride:n.normal.byteStride}:n.normal.data,elements:n.indices.data},drawMode:n.drawMode,material:a,transformMatrix:n.matrix}}(t,e);var c;J.setCanvas(r),J.setBackgroundColor(8900331),J.setAmbientLight(16777215,.5),n=J.setCamera(...Object.values(o)),J.addMesh(s),J.addLight((c={position:[-2,3,0],color:[1,1,1],intensity:20,cutoffDistance:0,decayExponent:2},{type:"point",position:[0,0,0],color:[1,1,1],intensity:3,cutoffDistance:5,decayExponent:1,...c,shader:D("${declaration?\r\n`\r\n\r\nfloat pow4(const in float x) {\r\n    float x2 = x * x;\r\n    return x2 * x2;\r\n}\r\nfloat pow2(const in float x) {\r\n    return x * x;\r\n}\r\n\r\nfloat saturate(const in float a) {\r\n    return clamp(a, 0.0f, 1.0f);\r\n}\r\n\r\nstruct LightParams {\r\n    vec3 irradiance;\r\n    vec3 direction;\r\n    vec3 color;\r\n    float distance;\r\n};\r\n\r\nstruct PointLight {\r\n    vec3 position;\r\n    vec3 color;\r\n    float cutoffDistance;\r\n    float decayExponent;\r\n};\r\n\r\nlayout(std140) uniform PointLights {\r\n    PointLight pointLights[NUM_POINT_LIGHTS];\r\n};\r\n\r\nfloat getDistanceAttenuation(const in float lightDistance, const in float cutoffDistance, const in float decayExponent) {\r\n\t// based upon Frostbite 3 Moving to Physically-based Rendering\r\n\t// page 32, equation 26: E[window1]\r\n\t// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\r\n    float distanceFalloff = 1.0f / max(pow(lightDistance, decayExponent), 0.01f);\r\n    if(cutoffDistance > 0.0f) {\r\n        distanceFalloff *= pow2(saturate(1.0f - pow4(lightDistance / cutoffDistance)));\r\n    }\r\n    return distanceFalloff;\r\n\r\n}\r\n\r\nLightParams getDirectDiffuse(const in PointLight pointLight,const in vec3 vertexPosition, const in vec3 normal,const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\r\n    LightParams lightParams = LightParams(vec3(0.0f), vec3(0.0f), vec3(0.0f), 0.0f);\r\n    vec3 lVector = pointLight.position - vertexPosition;\r\n    lightParams.distance = length(lVector);\r\n    lightParams.direction = normalize(lVector);\r\n    float dotNL = saturate(dot(normal, lightParams.direction));\r\n    lightParams.color = pointLight.color;\r\n    lightParams.color *= getDistanceAttenuation(lightParams.distance, pointLight.cutoffDistance, pointLight.decayExponent);\r\n    lightParams.irradiance = dotNL * lightParams.color;\r\n    \r\n    reflectedLight.directDiffuse += lightParams.irradiance * BRDF_Lambert(material.diffuseColor);\r\n    return lightParams;\r\n}\r\n\r\nfloat calculatePointLightBrightness(float lightDistance, float cutoffDistance, float decayExponent) {\r\n    return getDistanceAttenuation(lightDistance, cutoffDistance, decayExponent);\r\n}\r\n` : ''\r\n}\r\n${irradiance?\r\n`\r\n    vec3 irradiance = vec3(0.0f);\r\n    vec3 direction = vec3(0.0f);\r\n    for(int i = 0; i < NUM_POINT_LIGHTS; i++) {\r\n        PointLight pointLight = pointLights[i];\r\n        \r\n\r\n        LightParams lightParams = getDirectDiffuse(pointLight, vertex, normal, material, reflectedLight);\r\n        totalIrradiance += reflectedLight.directDiffuse;\r\n        ${specularIrradiance}\r\n    }\r\n` : ''\r\n}\r\n",{declaration:!1,irradiance:!1,specularIrradiance:""}),setupLights:mt,updateOneLight:dt})),J.setLoop(Lt),J.start(),function(t,e){let n,r;function a(t,e){const n=Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2));return{radius:n,polar:Math.acos(Math.max(-1,Math.min(1,(t[1]-e[1])/n))),azimuth:Math.atan2(t[0]-e[0],t[2]-e[2])}}function o(t){const o=t.clientX-n,s=t.clientY-r,c=e.get(),{position:l,target:u,fov:f}=c,{radius:m,polar:d,azimuth:p}=a(l,u),h=i(m,d-s/100,p-o/100);h[0]=h[0]+u[0],h[1]=h[1]+u[1],h[2]=h[2]+u[2],e.set(h,u,f),n=t.clientX,r=t.clientY}function i(t,e,n){const r=Math.sin(e)*t;return[r*Math.sin(n),Math.cos(e)*t,r*Math.cos(n)]}function s(e){t.removeEventListener("mousemove",o),t.removeEventListener("mouseup",s)}t.addEventListener("mousedown",(function(e){t.addEventListener("mousemove",o),n=e.clientX,r=e.clientY,t.addEventListener("mouseup",s)})),t.addEventListener("wheel",(function(t){const n=e.get(),{position:r,target:o,fov:s}=n,{radius:c,polar:l,azimuth:u}=a(r,o);console.log("radius",c);const f=i(c+.001*t.deltaY*c,l,u);f[0]=f[0]+o[0],f[1]=f[1]+o[1],f[2]=f[2]+o[2],e.set(f,o,s)}))}(r,n)})),[r,function(t){d[t?"unshift":"push"]((()=>{r=t,n(0,r)}))}]}class Rt extends w{constructor(t){super(),F(this,t,xt,Mt,o,{})}}export{Rt as default};
