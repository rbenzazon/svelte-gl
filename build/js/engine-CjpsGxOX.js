function e(){}function t(e){return e()}function n(){return Object.create(null)}function r(e){e.forEach(t)}function a(e){return"function"==typeof e}function o(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function i(t,...n){if(null==t){for(const e of n)e(void 0);return e}const r=t.subscribe(...n);return r.unsubscribe?()=>r.unsubscribe():r}function s(e){let t;return i(e,(e=>t=e))(),t}function c(e,t,n){e.$$.on_destroy.push(i(t,n))}function u(e,t,n,r){if(e){const a=l(e,t,n,r);return e[0](a)}}function l(e,t,n,r){return e[1]&&r?function(e,t){for(const n in t)e[n]=t[n];return e}(n.ctx.slice(),e[1](r(t))):n.ctx}function f(e,t,n,r){if(e[2]&&r){const a=e[2](r(n));if(void 0===t.dirty)return a;if("object"==typeof a){const e=[],n=Math.max(t.dirty.length,a.length);for(let r=0;r<n;r+=1)e[r]=t.dirty[r]|a[r];return e}return t.dirty|a}return t.dirty}function m(e,t,n,r,a,o){if(a){const i=l(t,n,r,o);e.p(i,a)}}function p(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let e=0;e<n;e++)t[e]=-1;return t}return-1}function d(e){return null==e?"":e}function g(e,t,n){return e.set(n),t}function h(e,t){e.appendChild(t)}function v(e,t,n){const r=function(e){if(!e)return document;const t=e.getRootNode?e.getRootNode():e.ownerDocument;if(t&&t.host)return t;return e.ownerDocument}(e);if(!r.getElementById(t)){const e=y("style");e.id=t,e.textContent=n,function(e,t){h(e.head||e,t),t.sheet}(r,e)}}function b(e,t,n){e.insertBefore(t,n||null)}function M(e){e.parentNode&&e.parentNode.removeChild(e)}function x(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function y(e){return document.createElement(e)}function A(e){return document.createTextNode(e)}function L(){return A(" ")}function P(){return A("")}function R(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}function E(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function w(e,t){t=""+t,e.data!==t&&(e.data=t)}function F(e,t,n){e.classList.toggle(t,!!n)}let _;function S(e){_=e}function T(){if(!_)throw new Error("Function called outside component initialization");return _}function B(e){T().$$.on_mount.push(e)}function C(){const e=T();return(t,n,{cancelable:r=!1}={})=>{const a=e.$$.callbacks[t];if(a){const o=function(e,t,{bubbles:n=!1,cancelable:r=!1}={}){return new CustomEvent(e,{detail:t,bubbles:n,cancelable:r})}(t,n,{cancelable:r});return a.slice().forEach((t=>{t.call(e,o)})),!o.defaultPrevented}return!0}}const $=[],D=[];let I=[];const N=[],U=Promise.resolve();let O=!1;function V(e){I.push(e)}const k=new Set;let Y=0;function j(){if(0!==Y)return;const e=_;do{try{for(;Y<$.length;){const e=$[Y];Y++,S(e),z(e.$$)}}catch(e){throw $.length=0,Y=0,e}for(S(null),$.length=0,Y=0;D.length;)D.pop()();for(let e=0;e<I.length;e+=1){const t=I[e];k.has(t)||(k.add(t),t())}I.length=0}while($.length);for(;N.length;)N.pop()();O=!1,k.clear(),S(e)}function z(e){if(null!==e.fragment){e.update(),r(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(V)}}const H=new Set;let q;function G(){q={r:0,c:[],p:q}}function W(){q.r||r(q.c),q=q.p}function X(e,t){e&&e.i&&(H.delete(e),e.i(t))}function K(e,t,n,r){if(e&&e.o){if(H.has(e))return;H.add(e),q.c.push((()=>{H.delete(e),r&&(n&&e.d(1),r())})),e.o(t)}else r&&r()}function J(e){return void 0!==e?.length?e:Array.from(e)}function Q(e){e&&e.c()}function Z(e,n,o){const{fragment:i,after_update:s}=e.$$;i&&i.m(n,o),V((()=>{const n=e.$$.on_mount.map(t).filter(a);e.$$.on_destroy?e.$$.on_destroy.push(...n):r(n),e.$$.on_mount=[]})),s.forEach(V)}function ee(e,t){const n=e.$$;null!==n.fragment&&(!function(e){const t=[],n=[];I.forEach((r=>-1===e.indexOf(r)?t.push(r):n.push(r))),n.forEach((e=>e())),I=t}(n.after_update),r(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function te(e,t){-1===e.$$.dirty[0]&&($.push(e),O||(O=!0,U.then(j)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function ne(t,a,o,i,s,c,u=null,l=[-1]){const f=_;S(t);const m=t.$$={fragment:null,ctx:[],props:c,update:e,not_equal:s,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(a.context||(f?f.$$.context:[])),callbacks:n(),dirty:l,skip_bound:!1,root:a.target||f.$$.root};u&&u(m.root);let p=!1;if(m.ctx=o?o(t,a.props||{},((e,n,...r)=>{const a=r.length?r[0]:n;return m.ctx&&s(m.ctx[e],m.ctx[e]=a)&&(!m.skip_bound&&m.bound[e]&&m.bound[e](a),p&&te(t,e)),n})):[],m.update(),p=!0,r(m.before_update),m.fragment=!!i&&i(m.ctx),a.target){if(a.hydrate){const e=function(e){return Array.from(e.childNodes)}(a.target);m.fragment&&m.fragment.l(e),e.forEach(M)}else m.fragment&&m.fragment.c();a.intro&&X(t.$$.fragment),Z(t,a.target,a.anchor),j()}S(f)}class re{$$=void 0;$$set=void 0;$destroy(){ee(this,1),this.$destroy=e}$on(t,n){if(!a(n))return e;const r=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return r.push(n),()=>{const e=r.indexOf(n);-1!==e&&r.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}"undefined"!=typeof window&&(window.__svelte||(window.__svelte={v:new Set})).v.add("4");const ae=[];function oe(t,n=e){let r;const a=new Set;function i(e){if(o(t,e)&&(t=e,r)){const e=!ae.length;for(const e of a)e[1](),ae.push(e,t);if(e){for(let e=0;e<ae.length;e+=2)ae[e][0](ae[e+1]);ae.length=0}}}function s(e){i(e(t))}return{set:i,update:s,subscribe:function(o,c=e){const u=[o,c];return a.add(u),1===a.size&&(r=n(i,s)||e),o(t),()=>{a.delete(u),0===a.size&&r&&(r(),r=null)}}}}function ie(t,n,o){const s=!Array.isArray(t),c=s?[t]:t;if(!c.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const u=n.length<2;return l=(t,o)=>{let l=!1;const f=[];let m=0,p=e;const d=()=>{if(m)return;p();const r=n(s?f[0]:f,t,o);u?t(r):p=a(r)?r:e},g=c.map(((e,t)=>i(e,(e=>{f[t]=e,m&=~(1<<t),l&&d()}),(()=>{m|=1<<t}))));return l=!0,d(),function(){r(g),p(),l=!1}},{subscribe:oe(o,l).subscribe};var l}const se=function(){const e=oe([]),t=oe(0),{subscribe:n,update:r}=e;function a(e){try{r((n=>{const r=e(n);return t.update((e=>e+1)),r}))}catch(e){console.log(e)}}return{subscribe:n,set:function(e){a((t=>e))},update:a,get revision(){return s(t)}}}();var ce=1e-6,ue="undefined"!=typeof Float32Array?Float32Array:Array;function le(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function fe(e){var t=e[0],n=e[1],r=e[2],a=e[3],o=e[4],i=e[5],s=e[6],c=e[7],u=e[8],l=e[9],f=e[10],m=e[11],p=e[12],d=e[13],g=e[14],h=e[15];return(t*i-n*o)*(f*h-m*g)-(t*s-r*o)*(l*h-m*d)+(t*c-a*o)*(l*g-f*d)+(n*s-r*i)*(u*h-m*p)-(n*c-a*i)*(u*g-f*p)+(r*c-a*s)*(u*d-l*p)}function me(e,t,n){var r=t[0],a=t[1],o=t[2],i=t[3],s=t[4],c=t[5],u=t[6],l=t[7],f=t[8],m=t[9],p=t[10],d=t[11],g=t[12],h=t[13],v=t[14],b=t[15],M=n[0],x=n[1],y=n[2],A=n[3];return e[0]=M*r+x*s+y*f+A*g,e[1]=M*a+x*c+y*m+A*h,e[2]=M*o+x*u+y*p+A*v,e[3]=M*i+x*l+y*d+A*b,M=n[4],x=n[5],y=n[6],A=n[7],e[4]=M*r+x*s+y*f+A*g,e[5]=M*a+x*c+y*m+A*h,e[6]=M*o+x*u+y*p+A*v,e[7]=M*i+x*l+y*d+A*b,M=n[8],x=n[9],y=n[10],A=n[11],e[8]=M*r+x*s+y*f+A*g,e[9]=M*a+x*c+y*m+A*h,e[10]=M*o+x*u+y*p+A*v,e[11]=M*i+x*l+y*d+A*b,M=n[12],x=n[13],y=n[14],A=n[15],e[12]=M*r+x*s+y*f+A*g,e[13]=M*a+x*c+y*m+A*h,e[14]=M*o+x*u+y*p+A*v,e[15]=M*i+x*l+y*d+A*b,e}function pe(e,t,n){var r,a,o,i,s,c,u,l,f,m,p,d,g=n[0],h=n[1],v=n[2];return t===e?(e[12]=t[0]*g+t[4]*h+t[8]*v+t[12],e[13]=t[1]*g+t[5]*h+t[9]*v+t[13],e[14]=t[2]*g+t[6]*h+t[10]*v+t[14],e[15]=t[3]*g+t[7]*h+t[11]*v+t[15]):(r=t[0],a=t[1],o=t[2],i=t[3],s=t[4],c=t[5],u=t[6],l=t[7],f=t[8],m=t[9],p=t[10],d=t[11],e[0]=r,e[1]=a,e[2]=o,e[3]=i,e[4]=s,e[5]=c,e[6]=u,e[7]=l,e[8]=f,e[9]=m,e[10]=p,e[11]=d,e[12]=r*g+s*h+f*v+t[12],e[13]=a*g+c*h+m*v+t[13],e[14]=o*g+u*h+p*v+t[14],e[15]=i*g+l*h+d*v+t[15]),e}function de(e,t,n){var r=n[0],a=n[1],o=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*a,e[5]=t[5]*a,e[6]=t[6]*a,e[7]=t[7]*a,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function ge(e,t,n){var r=Math.sin(n),a=Math.cos(n),o=t[4],i=t[5],s=t[6],c=t[7],u=t[8],l=t[9],f=t[10],m=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*a+u*r,e[5]=i*a+l*r,e[6]=s*a+f*r,e[7]=c*a+m*r,e[8]=u*a-o*r,e[9]=l*a-i*r,e[10]=f*a-s*r,e[11]=m*a-c*r,e}function he(e,t,n){var r=Math.sin(n),a=Math.cos(n),o=t[0],i=t[1],s=t[2],c=t[3],u=t[8],l=t[9],f=t[10],m=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*a-u*r,e[1]=i*a-l*r,e[2]=s*a-f*r,e[3]=c*a-m*r,e[8]=o*r+u*a,e[9]=i*r+l*a,e[10]=s*r+f*a,e[11]=c*r+m*a,e}function ve(e,t,n){var r=Math.sin(n),a=Math.cos(n),o=t[0],i=t[1],s=t[2],c=t[3],u=t[4],l=t[5],f=t[6],m=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*a+u*r,e[1]=i*a+l*r,e[2]=s*a+f*r,e[3]=c*a+m*r,e[4]=u*a-o*r,e[5]=l*a-i*r,e[6]=f*a-s*r,e[7]=m*a-c*r,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var be,Me=function(e,t,n,r,a){var o,i=1/Math.tan(t/2);return e[0]=i/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=a&&a!==1/0?(o=1/(r-a),e[10]=(a+r)*o,e[14]=2*a*r*o):(e[10]=-1,e[14]=-2*r),e};function xe(e,t){var n=t[0],r=t[1],a=t[2],o=n*n+r*r+a*a;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function ye(e,t,n,r){var a=t[0],o=t[1],i=t[2];return e[0]=a+r*(n[0]-a),e[1]=o+r*(n[1]-o),e[2]=i+r*(n[2]-i),e}function Ae(e,t,n){var r=t[0],a=t[1],o=t[2],i=n[3]*r+n[7]*a+n[11]*o+n[15];return i=i||1,e[0]=(n[0]*r+n[4]*a+n[8]*o+n[12])/i,e[1]=(n[1]*r+n[5]*a+n[9]*o+n[13])/i,e[2]=(n[2]*r+n[6]*a+n[10]*o+n[14])/i,e}function Le(){return new Array(3).fill(0)}function Pe(e,t){return e[0]*=t,e[1]*=t,e[2]*=t,e}function Re(e){for(let t=0,n=e.length;t<n;t+=3){const n=e[t+0],r=e[t+1],a=e[t+2],o=1/Math.sqrt(n*n+r*r+a*a);e[t+0]*=o,e[t+1]*=o,e[t+2]*=o}}be=new ue(3),ue!=Float32Array&&(be[0]=0,be[1]=0,be[2]=0);const Ee=Math.PI/180;function we(e){return e*Ee}function Fe(){return new Float32Array(16)}function _e(e){return new Float32Array(e)}const Se=(e,t)=>{const n=Function.constructor(...Object.entries(t).map((([e,t])=>(""===t&&(t='""'),`${e}${null!=t?`=${t}`:""}`))),`return \`${e}\``);return e=>n(...Object.keys(t).map((t=>null!=e[t]?e[t]:void 0)))};function Te(e){return Array.isArray(e)?[...e]:"number"==typeof e?Be(e):"string"==typeof e&&e.startsWith("#")?Be(parseInt(e.replace("#","0x"))):e}function Be(e){return[(e>>16&255)/255,(e>>8&255)/255,(255&e)/255]}function Ce(e,t){return 3===t?e:e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function $e(e){return e.map((e=>Math.floor(255*e))).reduce(((e,t)=>e+t.toString(16).padStart(2,"0")),"#")}function De(e){return"#"+e.toString(16).padStart(6,"0")}function Ie(e){return parseInt(e.slice(1),16)}function Ne(e){return[parseInt(e.slice(1,3),16)/255,parseInt(e.slice(3,5),16)/255,parseInt(e.slice(5,7),16)/255]}function Ue(e){Oe={...Oe,...e}}let Oe={programMap:new Map,vaoMap:new Map,gl:null,program:null,vao:null,canvas:null,backgroundColor:null,ambientLightColor:null,toneMappings:null,existingProgram:!1};const Ve=Math.PI/180;const ke=function(){const e=oe({position:[0,0,-1],target:[0,0,0],fov:80,near:.1,far:1e3,up:[0,1,0]}),{subscribe:t,update:n}=e,r=oe(0);function a(e){n((t=>{const n={...t,...e(t)};return r.update((e=>e+1)),function(e){const{canvas:t}=Oe;o=function(e,t,n,r){var a,o,i,s,c,u,l,f,m,p,d=t[0],g=t[1],h=t[2],v=r[0],b=r[1],M=r[2],x=n[0],y=n[1],A=n[2];return Math.abs(d-x)<ce&&Math.abs(g-y)<ce&&Math.abs(h-A)<ce?le(e):(l=d-x,f=g-y,m=h-A,a=b*(m*=p=1/Math.hypot(l,f,m))-M*(f*=p),o=M*(l*=p)-v*m,i=v*f-b*l,(p=Math.hypot(a,o,i))?(a*=p=1/p,o*=p,i*=p):(a=0,o=0,i=0),s=f*i-m*o,c=m*a-l*i,u=l*o-f*a,(p=Math.hypot(s,c,u))?(s*=p=1/p,c*=p,u*=p):(s=0,c=0,u=0),e[0]=a,e[1]=s,e[2]=l,e[3]=0,e[4]=o,e[5]=c,e[6]=f,e[7]=0,e[8]=i,e[9]=u,e[10]=m,e[11]=0,e[12]=-(a*d+o*g+i*h),e[13]=-(s*d+c*g+u*h),e[14]=-(l*d+f*g+m*h),e[15]=1,e)}(Fe(),e.position,e.target,e.up),i=Me(Fe(),(n=e.fov,n*Ve),t.width/t.height,e.near,e.far);var n}(n),n}))}let o,i;return{subscribe:t,set:function(e){a((t=>e))},update:a,get revision(){return s(r)},get view(){return o},get projection(){return i}}}(),Ye=0;function je(){const e=Oe.canvas.getContext("webgl2");Oe.gl=e,e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.frontFace(e.CCW),e.cullFace(e.BACK)}function ze(e=!0){return function(){const{gl:t}=Oe;t.frontFace(e?t.CCW:t.CW)}}function He(){const{gl:e}=Oe;e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA)}function qe(){const{gl:e}=Oe;e.disable(e.BLEND)}function Ge(){const{gl:e,program:t}=Oe,n=e.getUniformLocation(t,"time");e.uniform1f(n,performance.now())}function We(e,t,n){return function(){const{gl:r}=Oe,a=e.attributes.positionsSize??3,o=e.attributes.elements?e.attributes.elements.length:e.attributes.positions.length/a;t?e.attributes.elements?r.drawElementsInstanced(r[n],o,r.UNSIGNED_SHORT,0,t):r.drawArraysInstanced(r[n],0,o,t):e.attributes.elements?r.drawElements(r[n],o,r.UNSIGNED_SHORT,0):r.drawArrays(r[n],0,o),r.bindVertexArray(null)}}function Xe(){const{gl:e,vao:t}=Oe;e.bindVertexArray(t)}function Ke(e){return function(){const{gl:t}=Oe,n=t.createProgram();Oe.programMap.set(e,n),Oe.vaoMap.set(e,new Map),Oe.program=n}}function Je(){const{gl:e,program:t}=Oe;e.linkProgram(t),e.getProgramParameter(t,e.LINK_STATUS)||console.error("ERROR linking program!",e.getProgramInfoLog(t))}function Qe(){const{gl:e,program:t}=Oe;e.validateProgram(t),e.getProgramParameter(t,e.VALIDATE_STATUS)||console.error("ERROR validating program!",e.getProgramInfoLog(t))}function Ze(){const{gl:e,program:t}=Oe;e.useProgram(t)}function et(){const{gl:e,backgroundColor:t}=Oe;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,e.canvas.width,e.canvas.height),Oe.frameBufferWidth=e.canvas.width,Oe.frameBufferHeight=e.canvas.height,e.clearColor(...t),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}function tt(e,t,n,r){return function(){const{gl:a,program:o}=Oe;let i="",s="",c="",u="";const[l]=t,f=l.animations?.filter((({type:e})=>"vertex"===e));f?.length>0&&(c+=f.reduce(((e,t)=>e+t.shader({declaration:!0})),""),u+=f.reduce(((e,t)=>e+t.shader({position:!0})),""),i+=c,s+=u);const m=Se("#version 300 es\r\nprecision highp float;\r\nprecision highp int;\r\n\r\n#define SHADER_NAME defaultVertex\r\n    \r\nin vec3 position;\r\nin vec3 normal;\r\nin vec2 uv;\r\n${instances ?\r\n`\r\nin mat4 modelMatrix;\r\nin mat4 modelViewMatrix;\r\nin mat3 normalMatrix;\r\n` : `\r\nuniform mat4 modelMatrix;\r\nuniform mat4 modelViewMatrix;\r\nuniform mat3 normalMatrix;\r\n`}\r\n\r\n\r\nuniform float time;\r\nuniform mat4 projectionMatrix;\r\nuniform mat4 viewMatrix;\r\n\r\n// Pass the color attribute down to the fragment shader\r\nout vec3 vertexColor;\r\nout vec3 vNormal;\r\nout vec3 vertex;\r\nout vec3 vViewPosition;\r\nout highp vec2 vUv;\r\n\r\n${declarations}\r\n\r\nvoid main() {\r\n    vec3 objectNormal = vec3( normal );\r\n    vec3 transformedNormal = objectNormal;\r\n    vec3 animatedPosition = position;\r\n    ${positionModifier}\r\n\r\n    vUv = vec3( uv, 1 ).xy;\r\n    // Pass the color down to the fragment shader (debug)\r\n    vertexColor = vec3(1.27,1.27,1.27);\r\n    // Pass the vertex down to the fragment shader TODO, change to support modelViewMatrix\r\n    vertex = vec3(modelMatrix * vec4(animatedPosition, 1.0));\r\n\r\n    transformedNormal = normalMatrix * transformedNormal;\r\n    vNormal = normalize( transformedNormal );\r\n    //vNormal = normal;\r\n    vec3 transformed = vec3( animatedPosition );\r\n    vec4 mvPosition = vec4( transformed, 1.0 );\r\n    mvPosition = modelViewMatrix * mvPosition;\r\n    gl_Position = projectionMatrix * mvPosition;\r\n    vViewPosition = -mvPosition.xyz;\r\n}",{instances:!1,declarations:"",positionModifier:""})({instances:l.instances>=1,declarations:i,positionModifier:s});let p="",d="",g="";e.specular&&(p=e.specular.shader({declaration:!0}),d=e.specular.shader({material:!0}),g=e.specular.shader({irradiance:!0}));let h="",v="";e.diffuseMap&&(h=e.diffuseMap.shader({declaration:!0,declarationNormal:!1,mapType:e.diffuseMap.type}),v=e.diffuseMap.shader({diffuseMapSample:!0,mapType:e.diffuseMap.type,coordinateSpace:e.diffuseMap.coordinateSpace}));let b="",M="";e.normalMap&&(b=e.normalMap.shader({declaration:!0,declarationNormal:!0,mapType:e.normalMap.type}),M=e.normalMap.shader({normalMapSample:!0,mapType:e.normalMap.type}));let x="",y="";e.roughnessMap&&(x=e.roughnessMap.shader({declaration:!0,declarationNormal:!1,mapType:e.roughnessMap.type}),y=e.roughnessMap.shader({roughnessMapSample:!0,mapType:e.roughnessMap.type}));let A="",L="";e.envMap&&(A=e.envMap.shader({declaration:!0,...e.envMap.shaderDefines}),L=e.envMap.shader({irradiance:!0}));var P;!function(e,t,n,r){const a=e.createShader(e.VERTEX_SHADER);e.shaderSource(a,n),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)||console.error("ERROR compiling vertex shader!",e.getShaderInfoLog(a));e.attachShader(t,a);const o=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(o,r),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||console.error("ERROR compiling fragment shader!",e.getShaderInfoLog(o));e.attachShader(t,o)}(a,o,m,Se("#version 300 es\r\nprecision highp float;\r\nprecision highp int;\r\nprecision highp sampler2D;\r\nprecision highp samplerCube;\r\n\r\n#define SHADER_NAME defaultFragment\r\n\r\n${defines}\r\n\r\n#define RECIPROCAL_PI 0.3183098861837907\r\n\r\nuniform vec3 diffuse;\r\nuniform float opacity;\r\nuniform float metalness;\r\nuniform vec3 ambientLightColor;\r\nuniform vec3 cameraPosition;\r\nuniform mat4 viewMatrix;\r\n//uniform mat3 normalMatrix;\r\n\r\nin vec3 vertex;\r\nin vec3 vNormal;\r\nin highp vec2 vUv;\r\nin vec3 vViewPosition;\r\n\r\nout vec4 fragColor;\r\n\r\nfloat pow4(const in float x) {\r\n    float x2 = x * x;\r\n    return x2 * x2;\r\n}\r\nfloat pow2(const in float x) {\r\n    return x * x;\r\n}\r\n\r\nfloat saturate(const in float a) {\r\n    return clamp(a, 0.0f, 1.0f);\r\n}\r\n\r\nstruct ReflectedLight {\r\n\tvec3 directDiffuse;\r\n\tvec3 directSpecular;\r\n\tvec3 indirectDiffuse;\r\n\tvec3 indirectSpecular;\r\n};\r\n\r\nstruct PhysicalMaterial {\r\n\tvec3 diffuseColor;\r\n\tfloat diffuseAlpha;\r\n\tfloat roughness;\r\n\tvec3 specularColor;\r\n\tfloat specularF90;\r\n\tfloat ior;\r\n};\r\n\r\nvec3 BRDF_Lambert(const in vec3 diffuseColor) {\r\n\treturn RECIPROCAL_PI * diffuseColor;\r\n}\r\n\r\n\r\n${declarations}\r\n\r\nvec4 sRGBTransferOETF(in vec4 value) {\r\n\treturn vec4(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))), value.a);\r\n}\r\n\r\nvec4 linearToOutputTexel(vec4 value) {\r\n\treturn (sRGBTransferOETF(value));\r\n}\r\n\r\nvoid main() {\r\n    PhysicalMaterial material;\r\n\tmaterial.diffuseAlpha = 1.0;\r\n\tmaterial.diffuseColor = diffuse.rgb * (1.0 - metalness);\r\n\t${roughnessMapSample}\r\n\t${material}\r\n\t${diffuseMapSample}\r\n\t\r\n\r\n\tvec3 normal = normalize( vNormal );\r\n\tvec3 geometryPosition = - vViewPosition;\r\n    vec3 geometryNormal = normal;\r\n    vec3 geometryViewDir = normalize( vViewPosition );\r\n\t${normalMapSample}\r\n\t\r\n\r\n    ReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\r\n\r\n    reflectedLight.indirectDiffuse += ambientLightColor * BRDF_Lambert(material.diffuseColor);\r\n\r\n    vec3 totalIrradiance = vec3(0.0f);\r\n    ${irradiance}\r\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse + reflectedLight.directDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular;\r\n    fragColor = vec4(outgoingLight, opacity*material.diffuseAlpha);\r\n    //fragColor = vec4(totalIrradiance, 1.0f);\r\n    ${toneMapping}\r\n\tfragColor = linearToOutputTexel(fragColor);\r\n\t//fragColor = vec4(pointLights[0].position - geometryPosition,1.0);\r\n\t//fragColor = vec4(material.roughness,material.roughness,material.roughness,1.0);\r\n}",{defines:"",declarations:"",diffuseMapSample:"",normalMapSample:"",roughnessMapSample:"",material:"",irradiance:"",toneMapping:"",numPointLights:0})({defines:(P={...n?{NUM_POINT_LIGHTS:n}:void 0},["",...Object.entries(P).map((([e,t])=>`#define ${e} ${t}`))].join("\n")),declarations:[...n?[r({declaration:!0,irradiance:!1})]:[],...Oe.toneMappings?.length>0?[...Oe.toneMappings.map((e=>e.shader({declaration:!0,exposure:e.exposure})))]:[],...e.specular?[p]:[],...e.diffuseMap?[h]:[],...e.normalMap?[b]:[],...e.roughnessMap?[x]:[],...e.envMap?[A]:[]].join("\n"),diffuseMapSample:v,normalMapSample:M,roughnessMapSample:y,material:[...e.specular?[d]:[]].join("\n"),irradiance:[...n?[r({declaration:!1,irradiance:!0,specularIrradiance:g})]:[],...e.envMap?[L]:[]].join("\n"),toneMapping:[...Oe.toneMappings?.length>0?[...Oe.toneMappings.map((e=>e.shader({color:!0})))]:[]].join("\n"),numPointLights:n}))}}function nt({diffuse:e,metalness:t,opacity:n}){return function(){const{gl:r,program:a}=Oe,o=r.getUniformLocation(a,"diffuse");if(null==o)return;r.uniform3fv(o,new Float32Array(e.map(Ce))),null==t&&console.log("metalness is null, material won't display correctly");const i=r.getUniformLocation(a,"metalness");r.uniform1f(i,t);const s=r.getUniformLocation(a,"opacity");r.uniform1f(s,n??1)}}function rt(e,t){const{gl:n,program:r,ambientLightColor:a}=Oe,o=e??r,i=t??a,s=n.getUniformLocation(o,"ambientLightColor");n.uniform3fv(s,new Float32Array(i))}function at(e){return function(){const{gl:t,program:n}=Oe,{projection:r,view:a}=e,o=t.getUniformLocation(n,"projectionMatrix");t.uniformMatrix4fv(o,!1,r);const i=t.getUniformLocation(n,"cameraPosition");t.uniform3fv(i,s(e).position);const c=t.getUniformLocation(n,"viewMatrix");t.uniformMatrix4fv(c,!1,function(e){return function(e,t){var n=t[0],r=t[1],a=t[2],o=t[3],i=t[4],s=t[5],c=t[6],u=t[7],l=t[8],f=t[9],m=t[10],p=t[11],d=t[12],g=t[13],h=t[14],v=t[15],b=n*s-r*i,M=n*c-a*i,x=n*u-o*i,y=r*c-a*s,A=r*u-o*s,L=a*u-o*c,P=l*g-f*d,R=l*h-m*d,E=l*v-p*d,w=f*h-m*g,F=f*v-p*g,_=m*v-p*h,S=b*_-M*F+x*w+y*E-A*R+L*P;return S?(S=1/S,e[0]=(s*_-c*F+u*w)*S,e[1]=(a*F-r*_-o*w)*S,e[2]=(g*L-h*A+v*y)*S,e[3]=(m*A-f*L-p*y)*S,e[4]=(c*E-i*_-u*R)*S,e[5]=(n*_-a*E+o*R)*S,e[6]=(h*x-d*L-v*M)*S,e[7]=(l*L-m*x+p*M)*S,e[8]=(i*F-s*E+u*P)*S,e[9]=(r*E-n*F-o*P)*S,e[10]=(d*A-g*x+v*b)*S,e[11]=(f*x-l*A-p*b)*S,e[12]=(s*R-i*w-c*P)*S,e[13]=(n*w-r*R+a*P)*S,e[14]=(g*M-d*y-h*b)*S,e[15]=(l*y-f*M+m*b)*S,e):null}(Fe(),e)}(a))}}function ot(e,t,n){const r=e.getUniformLocation(t,"modelMatrix");null!=r&&e.uniformMatrix4fv(r,!1,n.value);const a=e.getUniformLocation(t,"modelViewMatrix");null!=a&&e.uniformMatrix4fv(a,!1,n.modelView)}function it(e,t,n,r){return null==r?function(){const{gl:e,program:t}=Oe;ot(e,t,n)}:function(){if(null==n)return;const{gl:r,program:a,vaoMap:o}=Oe,i=o.get(e).get(t);n.modelViewBuffer=st(r,a,i,"modelViewMatrix",n.modelView,4),st(r,a,i,"modelMatrix",n.value,4)}}function st(e,t,n,r,a,o){e.bindVertexArray(n);const i=e.getAttribLocation(t,r),s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,a.byteLength,e.DYNAMIC_DRAW);const c=4*o*o;for(let t=0;t<o;++t){const n=i+t;e.enableVertexAttribArray(n);const r=t*o*4;e.vertexAttribPointer(n,o,e.FLOAT,!1,c,r),e.vertexAttribDivisor(n,1)}return e.bufferSubData(e.ARRAY_BUFFER,0,a),e.bindVertexArray(null),s}function ct(e,t,n){return null==n?function(){const{gl:e,program:n}=Oe,r=e.getUniformLocation(n,"normalMatrix");null!=r&&e.uniformMatrix3fv(r,!1,t.matrix.normalMatrix)}:function(){const{gl:n,program:r,vaoMap:a}=Oe;if(null==n.getAttribLocation(r,"normalMatrix"))return;const o=a.get(e).get(t);t.matrices.normalMatrixBuffer=st(n,r,o,"normalMatrix",t.matrices.normalMatrices,3)}}function ut(e){let t,n;e.data?(t=e.data,n=e.interleaved):t=e;return{data:t.buffer&&t.buffer instanceof ArrayBuffer?t:new Float32Array(t),interleaved:n,...n?{byteStride:e.byteStride,byteOffset:e.byteOffset}:{byteStride:0,byteOffset:0}}}function lt(e,t){return function(){const{gl:n,program:r,vaoMap:a}=Oe,{positions:o,normals:i,elements:s,uvs:c,positionsSize:u}=t.attributes;let l;a.has(e)&&a.get(e).has(t)?l=a.get(e).get(t):(l=n.createVertexArray(),a.get(e).set(t,l)),Oe.vao=l,n.bindVertexArray(l);const{data:f,interleaved:m,byteStride:p,byteOffset:d}=ut(o),g=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,g),n.bufferData(n.ARRAY_BUFFER,f,n.STATIC_DRAW);const h=n.getAttribLocation(r,"position");n.bindBuffer(n.ARRAY_BUFFER,g);const v=null!=u?u:3;if(n.vertexAttribPointer(h,v,n.FLOAT,!1,p,d),n.enableVertexAttribArray(h),t.attributes.normals){const{data:e,interleaved:t,byteStride:a,byteOffset:o}=ut(i);if(!t){const t=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,t),n.bufferData(n.ARRAY_BUFFER,e,n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,t)}const s=n.getAttribLocation(r,"normal");-1!=s&&(n.vertexAttribPointer(s,3,n.FLOAT,!1,a,o),n.enableVertexAttribArray(s))}if(s){const e=Array.isArray(s)?new Uint16Array(s):s,t=n.createBuffer();n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e,n.STATIC_DRAW)}if(c){const e=Array.isArray(c)?new Float32Array(c):c,t=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,t),n.bufferData(n.ARRAY_BUFFER,e,n.STATIC_DRAW);const a=n.getAttribLocation(r,"uv");-1!=a&&(n.bindBuffer(n.ARRAY_BUFFER,t),n.vertexAttribPointer(a,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(a))}const b=["positions","normals","uvs","elements"];Object.entries(t.attributes).filter((([e])=>!b.includes(e))).forEach((([e,t])=>{if("object"==typeof t&&"itemSize"in t&&"array"in t){const a=Array.isArray(t.array)?new Float32Array(t.array):t.array,o=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,o),n.bufferData(n.ARRAY_BUFFER,a,n.STATIC_DRAW);const i=n.getAttribLocation(r,e);-1!=i&&(n.bindBuffer(n.ARRAY_BUFFER,o),n.vertexAttribPointer(i,t.itemSize,n.FLOAT,!1,0,0),n.enableVertexAttribArray(i))}})),n.bindVertexArray(null)}}function ft(e){return"matrix"in e}function mt(e){return"matrices"in e}function pt(e,t){if(null==e||null==t||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function dt(e){const{programMap:t,vaoMap:n}=Oe;t.forEach(((r,a)=>{e.some((e=>{return n=a,"material"in(t=e)?t.material===n.material:t.createProgram===n.createProgram&&pt(t.meshes,n.meshes);var t,n}))||(t.delete(a),n.delete(a))})),e.forEach((e=>{let r;if(t.forEach(((t,n)=>{n.material===e.material&&(r=n)})),null!=r){const t=n.get(r);t.forEach(((n,r)=>{e.meshes.includes(r)||t.delete(r)}))}}))}function gt(e,t){const{programMap:n,vaoMap:r}=Oe;let a,o;if(n.forEach(((t,n)=>{n.material===e.material&&(a=n,o=t)})),null!=a){const e=r.get(a);null!=e&&(r.delete(a),r.set(t,e)),n.delete(a),n.set(t,o)}}function ht(e){return Oe.existingProgram=!0,function(){const{programMap:t}=Oe,n=t.get(e);Oe.program=n}}const vt=e=>({type:"point",position:[0,0,0],color:[1,1,1],intensity:3,cutoffDistance:5,decayExponent:1,...e,shader:Se("${declaration?\r\n`\r\nstruct LightParams {\r\n    vec3 irradiance;\r\n    vec3 direction;\r\n    vec3 color;\r\n    float distance;\r\n};\r\n\r\nstruct PointLight {\r\n    vec3 position;\r\n    vec3 color;\r\n    float cutoffDistance;\r\n    float decayExponent;\r\n};\r\n\r\nlayout(std140) uniform PointLights {\r\n    PointLight pointLights[NUM_POINT_LIGHTS];\r\n};\r\n\r\nfloat getDistanceAttenuation(const in float lightDistance, const in float cutoffDistance, const in float decayExponent) {\r\n\t// based upon Frostbite 3 Moving to Physically-based Rendering\r\n\t// page 32, equation 26: E[window1]\r\n\t// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\r\n    float distanceFalloff = 1.0f / max(pow(lightDistance, decayExponent), 0.01f);\r\n    if(cutoffDistance > 0.0f) {\r\n        distanceFalloff *= pow2(saturate(1.0f - pow4(lightDistance / cutoffDistance)));\r\n    }\r\n    return distanceFalloff;\r\n\r\n}\r\n\r\nLightParams getDirectDiffuse(const in PointLight pointLight,const in vec3 geometryPosition, const in vec3 normal,const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\r\n    LightParams lightParams = LightParams(vec3(0.0f), vec3(0.0f), vec3(0.0f), 0.0f);\r\n    vec3 lVector = pointLight.position - geometryPosition;\r\n    lightParams.distance = length(lVector);\r\n    lightParams.direction = normalize(lVector);\r\n    float dotNL = saturate(dot(normal, lightParams.direction));\r\n    lightParams.color = pointLight.color;\r\n    lightParams.color *= getDistanceAttenuation(lightParams.distance, pointLight.cutoffDistance, pointLight.decayExponent);\r\n    lightParams.irradiance = dotNL * lightParams.color;\r\n    \r\n    reflectedLight.directDiffuse += lightParams.irradiance * BRDF_Lambert(material.diffuseColor);\r\n    return lightParams;\r\n}\r\n\r\nfloat calculatePointLightBrightness(float lightDistance, float cutoffDistance, float decayExponent) {\r\n    return getDistanceAttenuation(lightDistance, cutoffDistance, decayExponent);\r\n}\r\n` : ''\r\n}\r\n${irradiance?\r\n`\r\n    vec3 irradiance = vec3(0.0f);\r\n    vec3 direction = vec3(0.0f);\r\n    for(int i = 0; i < NUM_POINT_LIGHTS; i++) {\r\n        PointLight pointLight = pointLights[i];\r\n        LightParams lightParams = getDirectDiffuse(pointLight, geometryPosition, normal, material, reflectedLight);\r\n        totalIrradiance += reflectedLight.directDiffuse;\r\n        ${specularIrradiance}\r\n    }\r\n` : ''\r\n}\r\n",{declaration:!1,irradiance:!1,specularIrradiance:""}),setupLights:At,updateOneLight:Lt});let bt=null;const Mt=e=>{bt=e},xt=()=>bt;function yt(e,t,n){t.preMultipliedColor=[...t.color];const r=Ae(Le(),t.position,ke.view);Pe(t.preMultipliedColor,t.intensity),e[n]=r[0],e[n+1]=r[1],e[n+2]=r[2],e[n+4]=t.preMultipliedColor[0],e[n+5]=t.preMultipliedColor[1],e[n+6]=t.preMultipliedColor[2],e[n+7]=t.cutoffDistance,e[n+8]=t.decayExponent,e[n+9]=0,e[n+10]=0,e[n+11]=0,e[n+12]=0}function At(e){return function(){const{gl:t,program:n}=Oe;if(!xt()){const e=t.getUniformBlockIndex(n,"PointLights");t.uniformBlockBinding(n,e,Ye)}!function(e){const{gl:t}=Oe,n=e.length,r=new Float32Array(12*n);for(let t=0;t<n;t++)yt(r,s(e[t]),12*t);let a=xt();if(a)t.bindBuffer(t.UNIFORM_BUFFER,a);else{const e=t.createBuffer();t.bindBufferBase(t.UNIFORM_BUFFER,Ye,e),Mt(e)}t.bufferData(t.UNIFORM_BUFFER,r,t.DYNAMIC_DRAW)}(e)}}function Lt(e,t){const{gl:n}=Oe,r=e.filter((e=>"point"===s(e).type)).findIndex((e=>e===t)),a=xt();if(-1!==r){const e=new Float32Array(12),o=12*r;yt(e,s(t),0),n.bindBuffer(n.UNIFORM_BUFFER,a),n.bufferSubData(n.UNIFORM_BUFFER,o*Float32Array.BYTES_PER_ELEMENT,e)}}const Pt=e=>{const t=oe(e),{subscribe:n,set:r}=t,a={subscribe:n,set:e=>{r(e),Lt(s(Rt),a),Rt.set(s(Rt))}};return a};const Rt=function(){const e=oe([]),{subscribe:t,set:n}=e,r=oe(0);return{subscribe:t,set:e=>{n(e),r.update((e=>e+1))},get revision(){return s(r)}}}(),Et=ie([Rt],(([e])=>e.length));function wt(e){const t=oe(e),{subscribe:n,set:r,update:a}=t;return{subscribe:n,set:e=>{r(e),Ft.set(s(Ft)),se.set(s(se))},update:a}}const Ft=function(){const e=oe([]),{subscribe:t,set:n,update:r}=e,a=oe(0);return{subscribe:t,set:e=>{n(e),a.update((e=>e+1))},update:r,get revision(){return s(a)}}}();function _t(e){return e?.opacity<1||e?.transparent}function St(e){if(0===e.length)return e;let t=!1;const{projection:n,view:r}=ke,a=me(Fe(),n,r);e.forEach((e=>{(t||_t(e.material))&&(t=!0,e.meshes.forEach(((e,t)=>{if(e.matrix){const t=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}(Le(),e.matrix.value);e.clipSpacePosition=Ae(Le(),t,a)}else e.clipSpacePosition=[0,0,Number.MAX_VALUE]})),e.meshes=e.meshes.sort(((e,t)=>t.clipSpacePosition[2]-e.clipSpacePosition[2])))}));return e.sort(((e,t)=>null==e.material||null==t.material||null==e.meshes[0].clipSpacePosition||null==t.meshes[0].clipSpacePosition?0:t.meshes[0].clipSpacePosition[2]-e.meshes[0].clipSpacePosition[2]))}const Tt=function(){const e={canvas:null,loop:null,backgroundColor:16777215,ambientLightColor:[16777215,0],toneMappings:[],enabled:!1};let t=e,n=new Map;const r=oe(e),{subscribe:a,update:o}=r,i=oe(0);function c([e,t]){n.set("ambientLightColor",Te(e).map((e=>e*t)))}function u(e){o((r=>{const a=e(r);var o;i.update((e=>e+1)),a.canvas!==t.canvas&&function(e){const t=e.getBoundingClientRect(),n={canvas:{width:t.width,height:t.height}};e.width=t.width,e.height=t.height,Ue({...Oe,...n})}(a.canvas),null!=t.loop&&a.loop!==t.loop&&a.loop,a.backgroundColor!==t.backgroundColor&&(o=a.backgroundColor,n.set("backgroundColor",[...Te(o),1]));return null!=n.get("ambientLightColor")&&4===n.get("ambientLightColor").length||c(a.ambientLightColor),pt(a.ambientLightColor,t.ambientLightColor)||c(a.ambientLightColor),pt(a.toneMappings,t.toneMappings)||a.toneMappings,a.enabled!==t.enabled&&a.enabled,t=a,a}))}return{subscribe:a,set:function(e){u((t=>e))},update:u,get processed(){const e=s(r);return Object.entries(e).map((([e,t])=>n.has(e)?[e,n.get(e)]:[e,t])).reduce(((e,[t,n])=>(e[t]=n,e)),{})},get revision(){return s(i)}}}();function Bt(e){return e?.opacity<1||e?.transparent}Tt.subscribe((e=>{}));const Ct=oe([]);function $t(e,t){return(Bt(e.material)?1:-1)-(Bt(t.material)?1:-1)}function Dt(e,t){return e.order-t.order}const It=ie([se,Et,Ft,Ct],(([e,t,n,r])=>{let a=r.filter((e=>e.order<0)).reduce(((e,t)=>e.concat(...t.programs)),[]).map((t=>({...t,...t.updateProgram?{}:{updateProgram:[]},...t.allMeshes?{meshes:e}:{}}))),o=r.filter((e=>0===e.order)).reduce(((e,t)=>e.concat(...t.programs)),[]).map((t=>({...t,...t.updateProgram?{}:{updateProgram:[]},...t.allMeshes?{meshes:e}:{}}))),i=r.filter((e=>e.order>0)).reduce(((e,t)=>e.concat(...t.programs)),[]).map((t=>({...t,...t.updateProgram?{}:{updateProgram:[]},...t.allMeshes?{meshes:e}:{}}))).sort(Dt);const c=new Set(e.filter((e=>mt(e)||e.animations?.some((e=>"vertex"===e.type))))),u=St(Array.from(n).reduce(((t,n)=>{const r=e.filter((e=>e.material===n)),{currentNormalMeshes:a,currentSpecialMeshes:o}=r.reduce(((e,t)=>(c.has(t)?e.currentSpecialMeshes.push(t):e.currentNormalMeshes.push(t),e)),{currentNormalMeshes:[],currentSpecialMeshes:[]});return a.length>0&&t.push({material:s(n),meshes:a}),o.forEach((e=>{const r=e.animations?.some((e=>e.requireTime));t.push({requireTime:r,material:s(n),meshes:[e]})})),t}),[]).sort($t)),l=t;let f;l>0&&(f=s(s(Rt)[0]).shader);const m=[...a,...o,...u.map(((e,t)=>{if(e.material.program)return e.material.program.meshes=e.meshes,gt(e,e.material.program),e.material.program;const n=0===t,r={...e,useProgram:Ze,setupProgram:null,setFrameBuffer:null,setupMaterial:[rt],updateProgram:[],bindTextures:[],createProgram:Ke,selectProgram:ht,setupCamera:void 0};return gt(e,r),r.setupProgram=[tt(e.material,e.meshes,l,f),Je,Qe],n&&0===o.length&&(r.setFrameBuffer=et),e.material?.specular&&r.setupMaterial.push(e.material.specular.setupSpecular),e.material?.diffuseMap&&(r.setupMaterial.push(e.material.diffuseMap.setupTexture),r.bindTextures.push(e.material.diffuseMap.bindTexture)),e.material?.normalMap&&(r.setupMaterial.push(e.material.normalMap.setupTexture),r.bindTextures.push(e.material.normalMap.bindTexture)),e.material?.roughnessMap&&(r.setupMaterial.push(e.material.roughnessMap.setupTexture),r.bindTextures.push(e.material.roughnessMap.bindTexture)),e.material?.envMap&&(r.setupMaterial.push(e.material.envMap.setupTexture),r.bindTextures.push(e.material.envMap.bindTexture)),e.requireTime&&r.updateProgram.push(Ge),r.updateProgram.push(...Array.from(s(Rt).reduce(((e,t)=>{const n=s(t);return e.has(n.setupLights)?e.set(n.setupLights,[...e.get(n.setupLights),t]):e.set(n.setupLights,[t]),e}),new Map)).map((([e,t])=>e(t)))),r})),...i];return dt(m),m})),Nt=Fe();function Ut(e){return s(It).find((t=>!0!==t.allMeshes&&t.meshes.includes(e)))}le(Nt);const Ot=(e,t,n)=>{let r=n||Nt,a=new Float32Array(16),o=new Float32Array(9),i=ke.revision;function c(){Vt(a,r),kt(o,a)}c();const u={set:n=>{r=n,c();const a=Ut(e);!function(e,t){const{gl:n,programMap:r}=Oe,a=r.get(e);n.useProgram(a),ot(n,a,t)}(a,u),function(e,t){const{gl:n,programMap:r}=Oe,a=r.get(e),o=n.getUniformLocation(a,"normalMatrix");n.uniformMatrix3fv(o,!1,t.normalMatrix)}(a,u),t(s(Tt))},get value(){return r},get modelView(){return ke.revision!==i&&(c(),i=ke.revision),a},get normalMatrix(){return ke.revision!==i&&(c(),i=ke.revision),o}};return u};function Vt(e,t){me(e,ke.view,t)}function kt(e,t){return function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]}(e,t),e=function(e,t){var n=t[0],r=t[1],a=t[2],o=t[3],i=t[4],s=t[5],c=t[6],u=t[7],l=t[8],f=l*i-s*u,m=-l*o+s*c,p=u*o-i*c,d=n*f+r*m+a*p;return d?(d=1/d,e[0]=f*d,e[1]=(-l*r+a*u)*d,e[2]=(s*r-a*i)*d,e[3]=m*d,e[4]=(l*n-a*c)*d,e[5]=(-s*n+a*o)*d,e[6]=p*d,e[7]=(-u*n+r*c)*d,e[8]=(i*n-r*o)*d,e):null}(e,e),e=function(e,t){if(e===t){var n=t[1],r=t[2],a=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=r,e[7]=a}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}(e,e),e}const Yt=(e,t,n,r)=>{let a=Array.isArray(n)?function(e){const t=e.reduce(((e,t)=>e+t.length),0),n=new Float32Array(t);let r=0;return e.forEach((e=>{n.set(e,r),r+=e.length})),n}(n):n;const o=[],i=new Float32Array(16*r),s=[],c=new Float32Array(9*r),u=[];let l,f,m=ke.revision;for(let e=0;e<r;++e){const t=16*e*4,n=16;o.push(new Float32Array(a.buffer,t,n)),s.push(new Float32Array(i.buffer,t,n)),u.push(new Float32Array(c.buffer,9*e*4,9))}function p(e,t){Vt(s[t],e),kt(u[t],s[t])}function d(){o.forEach(((e,t)=>{p(e,t)}))}return{set:e=>{a=e},get value(){return a},setInstance(t,n){o[t].set(n),p(o[t],t);const r=Ut(e);!function(e,t,n,r,a){const{gl:o,vaoMap:i,matrixBuffer:s}=Oe;o.bindVertexArray(i.get(e).get(t)),o.bindBuffer(o.ARRAY_BUFFER,a),o.bufferSubData(o.ARRAY_BUFFER,64*r,n),o.bindVertexArray(null)}(r,e,s[t],t,l),function(e,t,n,r,a){const{gl:o,vaoMap:i}=Oe;o.bindVertexArray(i.get(e).get(t)),o.bindBuffer(o.ARRAY_BUFFER,a),o.bufferSubData(o.ARRAY_BUFFER,36*r,n),o.bindVertexArray(null)}(r,e,u[t],t,f)},getInstance:e=>o[e],get modelView(){return ke.revision!==m&&(d(),m=ke.revision),i},getModelViewInstance:e=>s[e],get modelViewWindows(){return s},set modelViewBuffer(e){l=e},get modelViewBuffer(){return l},get normalMatrices(){return ke.revision!==m&&(d(),m=ke.revision),c},set normalMatrixBuffer(e){f=e},get normalMatrixBuffer(){return f}}};function jt(e,t=!1,n=[0,0,0]){t&&console.log("symmetry");const r={...e};return ft(r)?r.matrix=Ot(r,Tt.set,r.matrix):mt(r)&&(r.matrices=Yt(r,Tt.set,r.matrices,r.instances)),r}const zt=8900331,Ht={0:"POINTS",1:"LINES",2:"LINE_LOOP",3:"LINE_STRIP",4:"TRIANGLES",5:"TRIANGLE_STRIP",6:"TRIANGLE_FAN"};function qt(e,t){let n,r;function a(t){let a="mousemove",o="mouseup",s=t;"touchstart"===t.type&&(a="touchmove",o="touchend",s=t.touches[0]),e.addEventListener(a,i,{passive:!1}),n=s.clientX,r=s.clientY,e.addEventListener(o,u,{passive:!1}),t.preventDefault(),t.stopPropagation()}function o(e,t){const n=Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2));return{radius:n,polar:Math.acos(Math.max(-1,Math.min(1,(e[1]-t[1])/n))),azimuth:Math.atan2(e[0]-t[0],e[2]-t[2])}}function i(e){let a=e;"touchmove"===e.type&&(a=e.touches[0]);const i=a.clientX-n,u=a.clientY-r,l=s(t),{position:f,target:m,fov:p}=l,{radius:d,polar:g,azimuth:h}=o(f,m),v=c(d,Math.max(.01,Math.min(Math.PI-.01,g-u/100)),h-i/100);v[0]=v[0]+m[0],v[1]=v[1]+m[1],v[2]=v[2]+m[2],t.set({position:v,target:m,fov:p}),n=a.clientX,r=a.clientY}function c(e,t,n){const r=Math.sin(t)*e;return[r*Math.sin(n),Math.cos(t)*e,r*Math.cos(n)]}function u(t){let n="mousemove",r="mouseup";"touchend"===t.type&&(n="touchmove",r="touchend"),e.removeEventListener(n,i,{passive:!1}),e.removeEventListener(r,u,{passive:!1})}e.addEventListener("touchstart",a,{passive:!1}),e.addEventListener("mousedown",a,{passive:!1}),e.addEventListener("wheel",(function(e){const n=s(t),{position:r,target:a,fov:i}=n,{radius:u,polar:l,azimuth:f}=o(r,a),m=c(u+.001*e.deltaY*u,l,f);m[0]=m[0]+a[0],m[1]=m[1]+a[1],m[2]=m[2]+a[2],t.set({position:m,target:a,fov:i})}),{passive:!1})}function Gt(e){v(e,"svelte-7mcxv8","button.svelte-7mcxv8.svelte-7mcxv8{position:relative;font-family:Arial;font-size:20px;padding:10px}ul.svelte-7mcxv8.svelte-7mcxv8{position:relative;display:none;font-family:Arial;font-size:20px}li.svelte-7mcxv8.svelte-7mcxv8{padding:10px;background-color:white;width:fit-content}li.svelte-7mcxv8 a.svelte-7mcxv8{text-decoration:none;color:black}.menuOpened.svelte-7mcxv8.svelte-7mcxv8{display:block}.current.svelte-7mcxv8.svelte-7mcxv8{color:red}")}function Wt(e,t,n){const r=e.slice();return r[3]=t[n],r}function Xt(t){let n,r,a,o=t[3].name+"";return{c(){n=y("li"),r=y("a"),a=A(o),E(r,"href",t[3].href),E(r,"class","svelte-7mcxv8"),E(n,"class","svelte-7mcxv8")},m(e,t){b(e,n,t),h(n,r),h(r,a)},p:e,d(e){e&&M(n)}}}function Kt(t){let n;return{c(){n=y("li"),n.textContent=`${t[3].name}`,E(n,"class","current svelte-7mcxv8")},m(e,t){b(e,n,t)},p:e,d(e){e&&M(n)}}}function Jt(e){let t;let n=function(e,t){return window.location.pathname===e[3].href.substring(1)?Kt:Xt}(e),r=n(e);return{c(){r.c(),t=P()},m(e,n){r.m(e,n),b(e,t,n)},p(e,t){r.p(e,t)},d(e){e&&M(t),r.d(e)}}}function Qt(t){let n,r,a,o,i,s=J(t[2]),c=[];for(let e=0;e<s.length;e+=1)c[e]=Jt(Wt(t,s,e));return{c(){n=y("button"),n.textContent="examples",r=L(),a=y("ul");for(let e=0;e<c.length;e+=1)c[e].c();E(n,"class","svelte-7mcxv8"),E(a,"class","svelte-7mcxv8"),F(a,"menuOpened",t[0])},m(e,s){b(e,n,s),b(e,r,s),b(e,a,s);for(let e=0;e<c.length;e+=1)c[e]&&c[e].m(a,null);o||(i=R(n,"click",t[1]),o=!0)},p(e,[t]){if(4&t){let n;for(s=J(e[2]),n=0;n<s.length;n+=1){const r=Wt(e,s,n);c[n]?c[n].p(r,t):(c[n]=Jt(r),c[n].c(),c[n].m(a,null))}for(;n<c.length;n+=1)c[n].d(1);c.length=s.length}1&t&&F(a,"menuOpened",e[0])},i:e,o:e,d(e){e&&(M(n),M(r),M(a)),x(c,e),o=!1,i()}}}function Zt(e,t,n){let r=!1;return[r,function(){n(0,r=!r)},[{name:"Normal map and specular",href:"./golf-ball"},{name:"GLTF loader",href:"./"},{name:"Obj loader",href:"./venus"},{name:"Cube",href:"./cube"},{name:"rock",href:"./rock"},{name:"GLTF",href:"./gltf"},{name:"Contact Shadow",href:"./contact-shadow"},{name:"Transparency",href:"./transparency"},{name:"Instances",href:"./instances"},{name:"Matrix",href:"./matrix"},{name:"Texture",href:"./texture"},{name:"Lights",href:"./lights"},{name:"Vertex Animation",href:"./vertex-anim"},{name:"Scene Update",href:"./scene-update"},{name:"Skybox HDR",href:"./skybox"},{name:"Skybox  Cube Map",href:"./skybox-cube"}]]}class en extends re{constructor(e){super(),ne(this,e,Zt,Qt,o,{},Gt)}}const tn=oe({init:!1});function nn(e,t){return function(){const{vaoMap:n}=Oe,r=n.get(e).get(t);Oe.vao=r}}const rn=[],an=new Map;an.set(Tt,0),an.set(se,0),an.set(ke,0),an.set(Ft,0),an.set(Rt,0);const on=oe(0);console.log("renderPipeline created");const sn=ie([Tt,It,ke,on],(([e,t,n,r])=>{if(!e.enabled||4===r||1===r||0===t.length)return rn;const a=function(){const e=new Set;return an.get(Tt)!==Tt.revision&&e.add(Tt),an.get(se)!==se.revision&&e.add(se),an.get(ke)!==ke.revision&&e.add(ke),an.get(Ft)!==Ft.revision&&e.add(Ft),an.get(Rt)!==Rt.revision&&e.add(Rt),an.set(Tt,Tt.revision),an.set(se,se.revision),an.set(ke,ke.revision),an.set(Ft,Ft.revision),an.set(Rt,Rt.revision),e}();if(0===a.size&&2!==r&&!t.some((e=>"requireTime"in e)))return rn;const o=Tt.processed;const i=[];Ue({canvas:e.canvas,backgroundColor:o.backgroundColor,ambientLightColor:o.ambientLightColor,...e.toneMappings.length>0?{toneMappings:e.toneMappings}:void 0});s(tn).init||i.push(je);const c=St(t);let u=!1;return i.push(qe),i.push(...c.reduce(((e,t)=>(Oe.existingProgram=!1,_t(t.material)&&!u&&(u=!0,e.push(He)),[...e,...Oe.programMap.has(t)?[t.selectProgram(t),t.useProgram,...t.bindTextures?[...t.bindTextures]:[],...t.updateProgram]:[t.createProgram(t),...t.setupProgram,t.useProgram,...t.setupMaterial,...t.updateProgram],...t.setupCamera?[t.setupCamera(ke)]:[...a.has(ke)||!Oe.existingProgram?[at(ke)]:[]],...t.setFrameBuffer?[t.setFrameBuffer]:[],...t.meshes.reduce(((e,n)=>[...e,...Oe.vaoMap.has(t)&&Oe.vaoMap.get(t).has(n)?[nn(t,n),...ft(n)?[it(t,n,n.matrix),ct(t,n)]:[it(t,n,n.matrices,n.instances),ct(t,n,n.instances)]]:[lt(t,n),...t.material?[nt(t.material)]:[],it(t,n,ft(n)?n.matrix:n.matrices,n.instances),ct(t,n,n.instances),...n.animations?.map((e=>e.setupAnimation))||[]],...null!=n.matrix?[...mt(n)?[ze(fe(n.matrices.getInstance(0))>0)]:[ze(fe(n.matrix.value)>0)]]:[],Xe,We(n,n.instances,n.drawMode)]),[]),...t.postDraw?[t.postDraw]:[]])),[])),i}),rn);ie([sn],(([e])=>{if(0===e.length)return 0;if(!s(tn).init&&0===s(on))return on.set(1),e.forEach((e=>{e()})),tn.set({init:!0}),on.set(2),1;if(2===s(on))return on.set(3),requestAnimationFrame((async function e(){on.set(4);const t=s(Tt);t.loop&&t.loop(),on.set(3),s(sn).forEach((e=>{e()})),on.set(4),requestAnimationFrame(e)})),2})).subscribe((e=>{})),sn.subscribe((e=>{}));export{De as $,zt as A,le as B,Fe as C,pe as D,Pt as E,vt as F,jt as G,qt as H,de as I,D as J,wt as K,v as L,en as M,u as N,E as O,F as P,h as Q,R,re as S,m as T,p as U,f as V,A as W,w as X,C as Y,r as Z,d as _,Re as a,$e as a0,Ie as a1,J as a2,P as a3,G as a4,W as a5,x as a6,s as a7,Ne as a8,Se as a9,Oe as aa,he as ab,_e as ac,ge as ad,ve as ae,we as af,L as b,Le as c,Ht as d,y as e,Q as f,b as g,Z as h,ne as i,e as j,K as k,ye as l,Pe as m,xe as n,M as o,ee as p,c as q,B as r,o as s,X as t,Tt as u,Rt as v,se as w,Ft as x,ke as y,g as z};
