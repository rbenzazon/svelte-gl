import{U as e,S as t,i as n,s as r,M as a,e as i,a as o,c as s,b as c,m as f,n as l,t as u,d as g,f as E,g as T,h as m,o as p,r as R,k as d,p as x,q as h,j as _,u as v,v as A,C as b,D as U,x as F,y as M,w as D,A as w,E as B,I as L}from"./engine.js";import{c as C}from"./skybox.js";import{c as O,a as y}from"./polyhedron.js";import{g as N,h as P,a as I,b as S}from"./environment-map-texture.js";import{c as G}from"./specular.js";const X=e=>new Promise(((t,n)=>{const r=document.createElement("img");r.onload=()=>{t(r)},r.onerror=e=>{n(e)},r.src=URL.createObjectURL(e)})),H=new Float32Array([-1,1,0,1,1,0,-1,-1,0,1,-1,0]),W=new Float32Array([0,1,1,1,0,0,1,0]);async function j(t){const n=document.getElementsByTagName("canvas")[0].getContext("webgl2"),r=await fetch(t),a=await r.arrayBuffer(),i=function(e){const t=(new TextDecoder).decode(e),n="<x:xmpmeta";let r=t.indexOf(n);const a="</x:xmpmeta>";for(;-1!==r;){const e=t.indexOf(a,r);if(-1===r||-1===e)return null;const i=t.slice(r,e+12),o=(new DOMParser).parseFromString(i,"text/xml").getElementsByTagName("rdf:Description")[0],s=Object.fromEntries(Array.from(o.attributes).map((e=>[e.name.split(":")[1],e.value])).map((([e,t])=>[e.substr(0,3).toLowerCase()+e.substr(3),t])).map((([e,t])=>[e,isNaN(t)?"True"===t||"False"===t?"True"===t:t:parseFloat(t)])).slice(1));if(null!=s.hdrCapacityMax)return s;r=t.indexOf(n,e)}return null}(a),o=function(e,t=!0,n=!0){const r=new DataView(e);if(65496!==r.getUint16(0))return;const a=r.byteLength;let i,o=2,s=0;for(;o<a;){if(++s>250)return;if(255!==r.getUint8(o))return;if(i=r.getUint8(o+1),226===i){const e=o+4;if(1297106432===r.getUint32(e)){const a=e+4;let i;if(18761===r.getUint16(a))i=!1;else{if(19789!==r.getUint16(a))return;i=!0}if(42!==r.getUint16(a+2,!i))return;const o=r.getUint32(a+4,!i);if(o<8)return;const s=a+o,c=r.getUint16(s,!i),f=s+2;let l=0;for(let e=f;e<f+12*c;e+=12)45057===r.getUint16(e,!i)&&(l=r.getUint32(e+8,!i));const u=s+2+12*c+4,g=[];for(let e=u;e<u+16*l;e+=16){const t={MPType:r.getUint32(e,!i),size:r.getUint32(e+4,!i),dataOffset:r.getUint32(e+8,!i),dependantImages:r.getUint32(e+12,!i),start:-1,end:-1,isFII:!1};t.dataOffset?(t.start=a+t.dataOffset,t.isFII=!1):(t.start=0,t.isFII=!0),t.end=t.start+t.size,g.push(t)}if(n&&g.length){const e=new Blob([r]),n=[];for(const r of g){if(r.isFII&&!t)continue;const a=e.slice(r.start,r.end+1,"image/jpeg");console.log("imageBlob",a),n.push(a)}return n}}}o+=2+r.getUint16(o+2)}}(a);if(2!==o.length)return null;const{texture:s,width:c,height:f}=await async function(t,n,r){const a=n.getExtension("EXT_color_buffer_float");if(!a)throw new Error("EXT_color_buffer_float extension not supported");const i=await X(t[0]),o=await X(t[1]),{width:s,height:c}=i,{sdrTexture:f,gainMapTexture:l}=function(e,t,n){const r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL),e.texImage2D(e.TEXTURE_2D,0,e.SRGB8_ALPHA8,e.RGBA,e.UNSIGNED_BYTE,t),z(e);const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),z(e),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL),{sdrTexture:r,gainMapTexture:a}}(n,i,o),{fbo:u,texture:g}=function(e,t,n){const r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r),z(e),e.texImage2D(e.TEXTURE_2D,0,e.RGBA16F,t,n,0,e.RGBA,e.HALF_FLOAT,null);const a=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,a),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0),e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null),{fbo:a,texture:r}}(n,s,c),{hdrCapacityMin:E,hdrCapacityMax:T}=r,m=Math.pow(2,r.hdrCapacityMax),p={sdr:f,gainMap:l,gamma:null!=r.gamma?new Array(3).fill(r.gamma):[1,1,1],offsetHDR:null!=r.offsetHDR?new Array(3).fill(r.offsetHDR):[1,1,1],offsetSDR:null!=r.offsetSDR?new Array(3).fill(r.offsetSDR):[1,1,1],gainMapMin:null!=r.gainMapMin?new Array(3).fill(r.gainMapMin):[0,0,0],gainMapMax:null!=r.gainMapMax?new Array(3).fill(r.gainMapMax):[1,1,1],weightFactor:(Math.log2(m)-E)/(T-E)};(function(t,n,r,a,i){const o=t.createProgram();e(t,o,n,r),t.linkProgram(o),t.useProgram(o),function(e,t,n){for(const[r,a]of Object.entries(n)){const n=e.getUniformLocation(t,r);if(a instanceof WebGLTexture){const t="sdr"===r?0:1;e.activeTexture(e["TEXTURE"+t]),e.bindTexture(e.TEXTURE_2D,a),e.uniform1i(n,t)}else if(Array.isArray(a))switch(a.length){case 2:e.uniform2fv(n,a);break;case 3:e.uniform3fv(n,a);break;case 4:e.uniform4fv(n,a)}else e.uniform1f(n,a)}}(t,o,a),function(e,t,n){for(const[r,{data:a,size:i}]of Object.entries(n)){const n=e.getAttribLocation(t,r),o=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,a,e.STATIC_DRAW),e.enableVertexAttribArray(n),e.vertexAttribPointer(n,i,e.FLOAT,!1,0,0)}}(t,o,i)})(n,V,$,p,{position:{data:H,size:3},uv:{data:W,size:2}}),function(e,t,n){e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0)}(n,u,g);const R=function(e){const t=e.getParameter(e.VIEWPORT),n=e.getParameter(e.DEPTH_TEST),r=e.getParameter(e.DEPTH_WRITEMASK),a=e.getParameter(e.BLEND);return{viewport:t,depthTest:n,depthWrite:r,blendEnabled:a}}(n),d={viewport:[0,0,s,c],depthTest:!1,depthWrite:!1,blendEnabled:!1,clear:!0};return k(n,d),function(e){e.drawArrays(e.TRIANGLE_STRIP,0,4)}(n),k(n,R),{texture:g,width:s,height:c}}(o,n,i);return{texture:s,width:c,height:f}}function k(e,t){t.blendEnabled?e.enable(e.BLEND):e.disable(e.BLEND),t.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(t.depthWrite);const[n,r,a,i]=t.viewport;isNaN(a)||isNaN(i)||e.viewport(n,r,a,i),t.clear&&(e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT))}function z(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR)}const V="#version 300 es\n\nprecision highp float;\n\nin vec3 position;\nin vec2 uv;\n\nout vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = vec4(position, 1.0);\n}\n",$="#version 300 es\n\nprecision highp float;\n// min half float value\n#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )\n// max half float value\n#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )\n\nuniform sampler2D sdr;\nuniform sampler2D gainMap;\nuniform vec3 gamma;\nuniform vec3 offsetHDR;\nuniform vec3 offsetSDR;\nuniform vec3 gainMapMin;\nuniform vec3 gainMapMax;\nuniform float weightFactor;\n\nin vec2 vUv;\n\nout vec4 fragColor;\n\nvec4 sRGBToLinear(vec4 srgbColor) {\n\tvec3 linearRGB = vec3(0.0);\n\tvec3 sRGB = srgbColor.rgb;\n\t\n\t// For each color channel, apply the proper conversion\n\tfor (int i = 0; i < 3; i++) {\n\t  if (sRGB[i] <= 0.04045) {\n\t\tlinearRGB[i] = sRGB[i] / 12.92;\n\t  } else {\n\t\tlinearRGB[i] = pow((sRGB[i] + 0.055) / 1.055, 2.4);\n\t  }\n\t}\n\treturn srgbColor;\n\treturn vec4(linearRGB, srgbColor.a);\n}\n\nvoid main() {\n  vec3 rgb = texture( sdr, vUv ).rgb;\n  vec3 recovery = texture( gainMap, vUv ).rgb;\n  vec3 logRecovery = pow( recovery, gamma );\n  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;\n  vec3 hdrColor = (rgb + offsetSDR) * exp2( logBoost * weightFactor ) - offsetHDR;\n  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));\n  fragColor = vec4( clampedHdrColor , 1.0 );\n}\n";function K(e){let t,n,r,m;return r=new a({}),{c(){t=i("canvas"),n=o(),s(r.$$.fragment)},m(a,i){c(a,t,i),e[1](t),c(a,n,i),f(r,a,i),m=!0},p:l,i(e){m||(u(r.$$.fragment,e),m=!0)},o(e){g(r.$$.fragment,e),m=!1},d(a){a&&(E(t),E(n)),e[1](null),T(r,a)}}}function Y(){}function q(e,t,n){let r,a,i,o,s,c,f;return m(e,R,(e=>n(3,r=e))),m(e,d,(e=>n(4,a=e))),m(e,x,(e=>n(5,i=e))),m(e,h,(e=>n(6,o=e))),m(e,_,(e=>n(7,s=e))),p((async()=>{v(R,r={...r,canvas:c,backgroundColor:A,ambientLightColor:[16777215,.1]},r),v(_,s={...s,position:[0,0,10],target:[0,0,0],fov:50},s),f=await j("spruit-sunrise-8k-hdr.jpg");const e=N(1),t=await C({texture:f.texture,width:f.texture.width,height:f.texture.height,cubeSize:2048,toneMapping:e,convertToCube:P}),n=I(f.texture,f.width,f.height);v(h,o=[t,n],o);const l=O(2,6,y);b(U({position:[-2,2,-2],color:[1,1,1],intensity:20,cutoffDistance:0,decayExponent:2}));const u=F(M()),g=S({envMap:n.getTexture,width:n.width,height:n.height,lodMax:n.lodMax}),E=D({diffuse:[1,1,1],metalness:1,specular:G({roughness:.05,ior:1.5,intensity:1,color:[1,1,1]}),envMap:g});v(x,i=[...i,E],i),v(d,a=[...a,w({...l,matrix:u,material:E})],a),v(R,r={...r,loop:Y,enabled:!0},r),B(c,_)})),[c,function(e){L[e?"unshift":"push"]((()=>{c=e,n(0,c)}))}]}class J extends t{constructor(e){super(),n(this,e,q,K,r,{})}}export{J as default};
