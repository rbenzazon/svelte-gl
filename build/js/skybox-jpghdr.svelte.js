import{U as e,S as t,i as n,s as a,M as r,e as i,a as o,c as s,b as c,m as f,n as u,t as l,d as g,f as T,g as m,h as E,o as d,r as p,k as R,p as x,q as h,j as v,u as A,v as b,C as M,D as U,x as _,y as F,w as D,A as w,E as y,I as L}from"./engine.js";import{c as B}from"./skybox.js";import{c as I,a as P}from"./polyhedron.js";import{g as O,h as C,a as N,b as H}from"./environment-map-texture.js";import{c as X}from"./specular.js";const S=e=>new Promise(((t,n)=>{const a=document.createElement("img");a.onload=()=>{t(a)},a.onerror=e=>{n(e)},a.src=URL.createObjectURL(e)})),j=new Float32Array([-1,1,0,1,1,0,-1,-1,0,1,-1,0]),G=new Float32Array([0,1,1,1,0,0,1,0]);async function W(t){const n=document.getElementsByTagName("canvas")[0].getContext("webgl2"),a=await fetch(t),r=await a.arrayBuffer(),i=function(e){const t=(new TextDecoder).decode(e),n="<x:xmpmeta";let a=t.indexOf(n);const r="</x:xmpmeta>";for(;-1!==a;){const e=t.indexOf(r,a);if(-1===a||-1===e)return null;const i=t.slice(a,e+12),o=(new DOMParser).parseFromString(i,"text/xml").getElementsByTagName("rdf:Description")[0],s=Object.fromEntries(Array.from(o.attributes).map((e=>[e.name.split(":")[1],e.value])).map((([e,t])=>[e.substr(0,3).toLowerCase()+e.substr(3),t])).map((([e,t])=>[e,isNaN(t)?"True"===t||"False"===t?"True"===t:t:parseFloat(t)])).slice(1));if(null!=s.hdrCapacityMax)return s;a=t.indexOf(n,e)}return null}(r),o=function(e,t=!0,n=!0){const a=new DataView(e);if(65496!==a.getUint16(0))return;const r=a.byteLength;let i,o=2,s=0;for(;o<r;){if(++s>250)return;if(255!==a.getUint8(o))return;if(i=a.getUint8(o+1),226===i){const e=o+4;if(1297106432===a.getUint32(e)){const r=e+4;let i;if(18761===a.getUint16(r))i=!1;else{if(19789!==a.getUint16(r))return;i=!0}if(42!==a.getUint16(r+2,!i))return;const o=a.getUint32(r+4,!i);if(o<8)return;const s=r+o,c=a.getUint16(s,!i),f=s+2;let u=0;for(let e=f;e<f+12*c;e+=12)45057===a.getUint16(e,!i)&&(u=a.getUint32(e+8,!i));const l=s+2+12*c+4,g=[];for(let e=l;e<l+16*u;e+=16){const t={MPType:a.getUint32(e,!i),size:a.getUint32(e+4,!i),dataOffset:a.getUint32(e+8,!i),dependantImages:a.getUint32(e+12,!i),start:-1,end:-1,isFII:!1};t.dataOffset?(t.start=r+t.dataOffset,t.isFII=!1):(t.start=0,t.isFII=!0),t.end=t.start+t.size,g.push(t)}if(n&&g.length){const e=new Blob([a]),n=[];for(const a of g){if(a.isFII&&!t)continue;const r=e.slice(a.start,a.end+1,"image/jpeg");console.log("imageBlob",r),n.push(r)}return n}}}o+=2+a.getUint16(o+2)}}(r);if(2!==o.length)return null;const{texture:s,width:c,height:f}=await async function(t,n,a){const r=await S(t[0]),i=await S(t[1]),{width:o,height:s}=r,{sdrTexture:c,gainMapTexture:f}=function(e,t,n){const a=e.createTexture();e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.SRGB8_ALPHA8,e.RGBA,e.UNSIGNED_BYTE,t),z(e);const r=e.createTexture();return e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.SRGB8_ALPHA8,e.RGBA,e.UNSIGNED_BYTE,n),z(e),{sdrTexture:a,gainMapTexture:r}}(n,r,i),{fbo:u,texture:l}=function(e,t,n){const a=e.createTexture();e.bindTexture(e.TEXTURE_2D,a),z(e),e.texImage2D(e.TEXTURE_2D,0,e.RGBA16F,t,n,0,e.RGBA,e.HALF_FLOAT,null);const r=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a,0),e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null),{fbo:r,texture:a}}(n,o,s),{hdrCapacityMin:g,hdrCapacityMax:T}=a;console.log(a);const m=Math.pow(2,a.hdrCapacityMax),E={sdr:c,gainMap:f,gamma:null!=a.gamma?new Array(3).fill(a.gamma):[1,1,1],offsetHDR:null!=a.offsetHDR?new Array(3).fill(a.offsetHDR):[1,1,1],offsetSDR:null!=a.offsetSDR?new Array(3).fill(a.offsetSDR):[1,1,1],gainMapMin:null!=a.gainMapMin?new Array(3).fill(a.gainMapMin):[0,0,0],gainMapMax:null!=a.gainMapMax?new Array(3).fill(a.gainMapMax):[1,1,1],weightFactor:(Math.log2(m)-g)/(T-g)};console.log(E);(function(t,n,a,r,i){const o=t.createProgram();e(t,o,n,a),t.linkProgram(o),t.useProgram(o),function(e,t,n){for(const[a,r]of Object.entries(n)){const n=e.getUniformLocation(t,a);if(r instanceof WebGLTexture){const t="sdr"===a?0:1;e.activeTexture(e["TEXTURE"+t]),e.bindTexture(e.TEXTURE_2D,r),e.uniform1i(n,t)}else if(Array.isArray(r))switch(r.length){case 2:e.uniform2fv(n,r);break;case 3:e.uniform3fv(n,r);break;case 4:e.uniform4fv(n,r)}else e.uniform1f(n,r)}}(t,o,r),function(e,t,n){for(const[a,{data:r,size:i}]of Object.entries(n)){const n=e.getAttribLocation(t,a),o=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.enableVertexAttribArray(n),e.vertexAttribPointer(n,i,e.FLOAT,!1,0,0)}}(t,o,i)})(n,$,Y,E,{position:{data:j,size:3},uv:{data:G,size:2}}),function(e,t,n){e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0)}(n,u,l);const d=function(e){const t=e.getParameter(e.VIEWPORT),n=e.getParameter(e.DEPTH_TEST),a=e.getParameter(e.DEPTH_WRITEMASK),r=e.getParameter(e.BLEND);return{viewport:t,depthTest:n,depthWrite:a,blendEnabled:r}}(n),p={viewport:[0,0,o,s],depthTest:!1,depthWrite:!1,blendEnabled:!1,clear:!0};return k(n,p),function(e){e.drawArrays(e.TRIANGLE_STRIP,0,4)}(n),k(n,d),{texture:l,width:o,height:s}}(o,n,i);return{texture:s,width:c,height:f}}function k(e,t){t.blendEnabled?e.enable(e.BLEND):e.disable(e.BLEND),t.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(t.depthWrite);const[n,a,r,i]=t.viewport;isNaN(r)||isNaN(i)||e.viewport(n,a,r,i),t.clear&&(e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT))}function z(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR)}const $="#version 300 es\n\nprecision highp float;\n\nin vec3 position;\nin vec2 uv;\n\nout vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = vec4(position, 1.0);\n}\n",Y="#version 300 es\n\nprecision highp float;\n// min half float value\n#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )\n// max half float value\n#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )\n\nuniform sampler2D sdr;\nuniform sampler2D gainMap;\nuniform vec3 gamma;\nuniform vec3 offsetHDR;\nuniform vec3 offsetSDR;\nuniform vec3 gainMapMin;\nuniform vec3 gainMapMax;\nuniform float weightFactor;\n\nin vec2 vUv;\n\nout vec4 fragColor;\n\nvoid main() {\n  vec3 rgb = texture( sdr, vUv ).rgb;\n  vec3 recovery = texture( gainMap, vUv ).rgb;\n  vec3 logRecovery = pow( recovery, gamma );\n  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;\n  vec3 hdrColor = (rgb + offsetSDR) * exp2( logBoost * weightFactor ) - offsetHDR;\n  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));\n  fragColor = vec4( clampedHdrColor , 1.0 );\n}\n";function V(e){let t,n,a,E;return a=new r({}),{c(){t=i("canvas"),n=o(),s(a.$$.fragment)},m(r,i){c(r,t,i),e[1](t),c(r,n,i),f(a,r,i),E=!0},p:u,i(e){E||(l(a.$$.fragment,e),E=!0)},o(e){g(a.$$.fragment,e),E=!1},d(r){r&&(T(t),T(n)),e[1](null),m(a,r)}}}function q(){}function K(e,t,n){let a,r,i,o,s,c,f;return E(e,p,(e=>n(3,a=e))),E(e,R,(e=>n(4,r=e))),E(e,x,(e=>n(5,i=e))),E(e,h,(e=>n(6,o=e))),E(e,v,(e=>n(7,s=e))),d((async()=>{A(p,a={...a,canvas:c,backgroundColor:b,ambientLightColor:[16777215,.1]},a),A(v,s={...s,position:[0,0,10],target:[0,0,0],fov:50},s),f=await W("spruit-sunrise-4k-hdr.jpg"),console.log("jpgHDRImage",f);const e=O(1),t=await B({texture:f.texture,width:f.texture.width,height:f.texture.height,cubeSize:2048,toneMapping:e,convertToCube:C}),n=N(f.texture,f.width,f.height);A(h,o=[t,n],o);const u=I(2,5,P);M(U({position:[-2,2,-2],color:[1,1,1],intensity:20,cutoffDistance:0,decayExponent:2}));const l=_(F()),g=H({envMap:n.getTexture,width:n.width,height:n.height,lodMax:n.lodMax}),T=D({diffuse:[1,1,1],metalness:1,specular:X({roughness:.05,ior:1.5,intensity:1,color:[1,1,1]}),envMap:g});A(x,i=[...i,T],i),A(R,r=[...r,w({...u,matrix:l,material:T})],r),A(p,a={...a,loop:q,enabled:!0},a),y(c,v)})),[c,function(e){L[e?"unshift":"push"]((()=>{c=e,n(0,c)}))}]}class J extends t{constructor(e){super(),n(this,e,K,V,a,{})}}export{J as default};
